<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCB TITLE MAKER</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        input:invalid {
            border-color: #e53e3e;
        }
        input:invalid:focus {
            border-color: #e53e3e;
            box-shadow: 0 0 0 1px #e53e3e;
        }
        [contenteditable]:empty:before {
            content: attr(data-placeholder);
            pointer-events: none;
            display: block;
            color: #9ca3af; 
        }
        .control-btn {
            height: 44px; 
            min-width: 100px; 
        }
        .tab-btn {
            background-color: #f3f4f6;
            color: #374151;
        }
        .active-tab {
            background-color: #4f46e5;
            color: #ffffff;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans flex flex-col md:flex-row">

    <div class="w-full md:max-w-sm bg-white p-8 shadow-2xl z-10 overflow-y-auto">
        <h2 class="text-2xl font-bold mb-6 text-center text-gray-800" id="main-title">Thông tin</h2>

        <div class="mb-4">
            <label for="language-selector" class="block text-sm font-medium text-gray-700 mb-1" id="language-label">Ngôn ngữ</label>
            <select id="language-selector" class="w-full h-10 p-2 text-sm bg-gray-50 border border-gray-300 rounded-lg cursor-pointer focus:ring-2 focus:ring-indigo-500">
                <option value="en" selected>English</option>
                <option value="id">Indonesia</option>
                <option value="ru">Russia</option>
                <option value="th">Thailand</option>
                <option value="vi">Việt Nam</option>
                <option value="ko">Korean</option>
            </select>
        </div>

        <form id="infoForm" onsubmit="handleSubmit(event)">
            <div class="mb-4">
                <label for="name" class="block text-sm font-medium text-gray-700 mr-3 shrink-0" id="main-name-label">Name:</label>
                <input 
                    type="text" 
                    id="name" 
                    name="user_name" 
                    required 
                    maxlength="16" 
                    class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                    placeholder="Nhập tên (tối đa 16 ký tự)"
                    data-placeholder-key="main_name_placeholder"
                >
            </div>

            <div class="mb-2">
                <button 
                    type="button" 
                    id="loginTrigger-1" 
                    onclick="toggleLoginTabs(1)" 
                    class="group w-full flex items-center justify-between p-3 cursor-pointer list-none rounded-md border border-gray-300 bg-white hover:bg-gray-50 shadow-sm transition-colors"
                >
                    <span class="font-medium text-gray-700" id="login-1-label">Login - 1</span>
                    <svg id="loginArrow-1" class="login-arrow w-5 h-5 text-gray-500 transition-transform duration-200" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                    </svg>
                </button>
                <div id="tabs-login-1" class="tabs-container hidden flex justify-center gap-2 py-2">
                    <button type="button" onclick="showColorPanel(1)" id="tab-name-1" class="tab-btn text-sm font-medium py-1 px-4 rounded-lg transition-colors" data-translate-key="tab_name">Name</button>
                    <button type="button" onclick="showImageSoundPanel(1)" id="tab-imagesound-1" class="tab-btn text-sm font-medium py-1 px-4 rounded-lg transition-colors" data-translate-key="tab_imagesound">Image/Sound</button>
                </div>
            </div>

            <div class="mb-2">
                <button 
                    type="button" 
                    id="loginTrigger-2" 
                    onclick="toggleLoginTabs(2)" 
                    class="group w-full flex items-center justify-between p-3 cursor-pointer list-none rounded-md border border-gray-300 bg-white hover:bg-gray-50 shadow-sm transition-colors"
                >
                    <span class="font-medium text-gray-700" id="login-2-label">Login - 2</span>
                    <svg id="loginArrow-2" class="login-arrow w-5 h-5 text-gray-500 transition-transform duration-200" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                    </svg>
                </button>
                <div id="tabs-login-2" class="tabs-container hidden flex justify-center gap-2 py-2">
                    <button type="button" onclick="showColorPanel(2)" id="tab-name-2" class="tab-btn text-sm font-medium py-1 px-4 rounded-lg transition-colors" data-translate-key="tab_name">Name</button>
                    <button type="button" onclick="showImageSoundPanel(2)" id="tab-imagesound-2" class="tab-btn text-sm font-medium py-1 px-4 rounded-lg transition-colors" data-translate-key="tab_imagesound">Image/Sound</button>
                </div>
            </div>

            <div class="mb-4">
                <button 
                    type="button" 
                    id="loginTrigger-3" 
                    onclick="toggleLoginTabs(3)" 
                    class="group w-full flex items-center justify-between p-3 cursor-pointer list-none rounded-md border border-gray-300 bg-white hover:bg-gray-50 shadow-sm transition-colors"
                >
                    <span class="font-medium text-gray-700" id="login-3-label">Login - 3</span>
                    <svg id="loginArrow-3" class="login-arrow w-5 h-5 text-gray-500 transition-transform duration-200" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                    </svg>
                </button>
                <div id="tabs-login-3" class="tabs-container hidden flex justify-center gap-2 py-2">
                    <button type="button" onclick="showColorPanel(3)" id="tab-name-3" class="tab-btn text-sm font-medium py-1 px-4 rounded-lg transition-colors" data-translate-key="tab_name">Name</button>
                    <button type="button" onclick="showImageSoundPanel(3)" id="tab-imagesound-3" class="tab-btn text-sm font-medium py-1 px-4 rounded-lg transition-colors" data-translate-key="tab_imagesound">Image/Sound</button>
                </div>
            </div>
            
            
            <div id="message" class="mt-4 text-green-600 font-medium text-center"></div>

            <div class="mt-6">
                <button 
                    type="submit"
                    id="submit-button"
                    class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150"
                >
                    Lưu
                </button>
            </div>
        </form>
    </div>

    <div 
        id="loginPanel" 
        class="w-full flex-grow p-4 md:p-8 hidden bg-gray-900 overflow-auto"
    >
        <div class="max-w-4xl mx-auto bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-10 border border-indigo-700/50">
        
            <div class="relative mb-8 pt-1 pb-4">
                <h3 class="text-xl font-bold text-center text-indigo-400" id="edit-name-title">Chỉnh sửa Name</h3>
            </div>

            <div class="mb-8">
                <div class="flex justify-between items-center mb-2">
                    <label for="input-editor" class="block text-lg font-bold text-gray-200" id="input-label">
                        Input
                    </label>
                    <div class="flex items-center gap-2">
                        <label for="bg-color-picker" id="bg-color-label" class="text-sm font-medium text-indigo-400">Background Color</label>
                        <input type="color" id="bg-color-picker" value="#6B7280" 
                                class="w-10 h-8 p-1 bg-gray-700 border border-indigo-600 rounded-lg cursor-pointer shadow-md focus:ring-2 focus:ring-indigo-500">
                        
                    </div>
                </div>
                
                <div id="input-editor" 
                    contenteditable="true" 
                    data-placeholder="Type, paste content, or select text and apply colors..."
                    data-placeholder-key="input_placeholder"
                    class="w-full min-h-[180px] p-4 font-mono text-white bg-gray-500 border-2 border-gray-600 rounded-xl shadow-inner focus:outline-none focus:ring-4 focus:ring-indigo-500 transition-all duration-300">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                
                <div class="flex flex-col space-y-4">
                    <div>
                        <label for="color-picker" class="block text-sm font-medium text-indigo-400 mb-1" id="start-color-label">
                            Start Color
                        </label>
                        <input type="color" id="color-picker" value="#374151" 
                                class="w-full h-10 p-1 bg-gray-700 border border-indigo-600 rounded-lg cursor-pointer shadow-md focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="color-picker-2" class="block text-sm font-medium text-indigo-400 mb-1" id="end-color-label">
                            End Color
                        </label>
                        <input type="color" id="color-picker-2" value="#EF4444" 
                                class="w-full h-10 p-1 bg-gray-700 border border-indigo-600 rounded-lg cursor-pointer shadow-md focus:ring-2 focus:ring-red-500">
                    </div>
                </div>

                <div class="md:col-span-2">
                    <label for="gradient-display" class="block text-sm font-medium text-indigo-400 mb-1" id="gradient-preview-label">
                        Gradient Preview
                    </label>
                    <div id="gradient-display" 
                            class="w-full h-32 border border-indigo-600 rounded-xl shadow-xl transition-all duration-300"
                            style="background: linear-gradient(to right, #374151, #EF4444);">
                    </div> 
                </div>
            </div>
            
            <div class="flex flex-wrap justify-center gap-3 mb-10">
                
                <button id="clear-color-button"
                        class="control-btn bg-gray-600 text-white text-sm font-bold py-2 px-4 rounded-lg shadow-lg hover:bg-gray-500 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-gray-300 transform hover:scale-[1.03] active:scale-[0.98]">
                    Clear Color
                </button>
                
                <button id="apply-color-button"
                        class="control-btn bg-indigo-600 text-white text-sm font-bold py-2 px-4 rounded-lg shadow-lg hover:bg-indigo-500 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-300 transform hover:scale-[1.03] active:scale-[0.98]">
                    Apply Color 1
                </button>
                
                <button id="apply-color-button-2"
                        class="control-btn bg-red-600 text-white text-sm font-bold py-2 px-4 rounded-lg shadow-lg hover:bg-red-500 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-red-300 transform hover:scale-[1.03] active:scale-[0.98]">
                    Apply Color 2
                </button>
                
                <button id="apply-gradient-button"
                        class="control-btn bg-purple-600 text-white text-sm font-bold py-2 px-4 rounded-lg shadow-lg hover:bg-purple-500 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-purple-300 transform hover:scale-[1.03] active:scale-[0.98]">
                    Create Gradient
                </button>
            </div>

            <div id="output-container" class="mt-8 hidden"> 
                <div class="flex justify-between items-center mb-2">
                    <label for="output-editor" id="output-label" class="block text-lg font-bold text-gray-200">
                        Output
                    </label>
                </div>
                
                <div id="output-editor" 
                    data-placeholder="Formatted result |c...|r will appear here..."
                    class="w-full min-h-[150px] p-4 border-2 border-gray-600 rounded-xl bg-gray-700 text-green-300 overflow-y-auto font-mono text-sm whitespace-pre-wrap select-all shadow-inner">
                </div>
            </div>

        </div>
    </div>

    <div 
        id="imageSoundPanel" 
        class="w-full flex-grow p-4 md:p-8 hidden bg-gray-900 overflow-auto"
    >
        <div class="max-w-4xl mx-auto bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-10 border border-indigo-700/50">
        
            <div class="relative mb-8 pt-1 pb-4">
                <h3 class="text-xl font-bold text-center text-indigo-400" id="edit-imagesound-title">Chỉnh sửa Image/Sound</h3>
            </div>

            <div class="mb-8">
                <label class="block text-lg font-bold text-gray-200 mb-2" id="image-upload-label">Tải ảnh (16:9, max 1920x1080)</label>
                <div class="flex items-center mt-2">
                    <label class="block">
                        <span class="sr-only" data-translate-key="choose_file_button">Choose file</span>
                        <input type="file" id="image-input" accept="image/png, image/jpeg" class="hidden" onchange="updateFileName('image-input', 'image-file-name')"/>
                        <span class="px-4 py-2 bg-indigo-600 text-white text-sm font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors duration-200 cursor-pointer" data-translate-key="choose_file_button">
                            Choose File
                        </span>
                    </label>
                    <span id="image-file-name" class="ml-4 text-gray-400 italic text-sm" data-translate-key="no_file_chosen">Chưa chọn tệp</span>
                </div>
                <p id="image-error-msg" class="text-red-500 text-sm mt-2"></p>
                
                <img id="image-preview" src="" alt="Image Preview" class="hidden mt-4 rounded-lg shadow-lg max-w-full h-auto bg-gray-700 p-1 border border-gray-600">
            </div>

            <div class="mb-8">
                <label class="block text-lg font-bold text-gray-200 mb-2" id="audio-upload-label">Tải âm thanh (Tối đa 30 giây, .mp3)</label>
                <div class="flex items-center mt-2">
                     <label class="block">
                        <span class="sr-only" data-translate-key="choose_file_button">Choose file</span>
                        <input type="file" id="audio-input" accept=".mp3" class="hidden" onchange="updateFileName('audio-input', 'audio-file-name')" />
                        <span class="px-4 py-2 bg-indigo-600 text-white text-sm font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors duration-200 cursor-pointer" data-translate-key="choose_file_button">
                            Choose File
                        </span>
                    </label>
                    <span id="audio-file-name" class="ml-4 text-gray-400 italic text-sm" data-translate-key="no_file_chosen">Chưa chọn tệp</span>
                </div>
                <p id="audio-error-msg" class="text-red-500 text-sm mt-2"></p>
                
                <audio id="audio-preview" controls class="hidden w-full mt-4"></audio>
            </div>

        </div>
    </div>


    <script>
        const loginPanel = document.getElementById('loginPanel');
        const imageSoundPanel = document.getElementById('imageSoundPanel');
        const allTabContainers = document.querySelectorAll('.tabs-container');
        const allLoginArrows = document.querySelectorAll('.login-arrow');
        const allTabButtons = document.querySelectorAll('.tab-btn');
        const inputEditor = document.getElementById('input-editor');

        let loginData = {
            1: { name: '', output: '', imageUrl: null, imageFile: null, audioUrl: null, audioFile: null, imageName: '', audioName: '' },
            2: { name: '', output: '', imageUrl: null, imageFile: null, audioUrl: null, audioFile: null, imageName: '', audioName: '' },
            3: { name: '', output: '', imageUrl: null, imageFile: null, audioUrl: null, audioFile: null, imageName: '', audioName: '' }
        };
        let currentActiveContext = null; 

        const translations_en = {
            main_title: 'Information',
            language_label: 'Language',
            main_name_label: 'Name:',
            main_name_placeholder: 'Enter name (max 16 chars)',
            login_1_label: 'Login - 1',
            login_2_label: 'Login - 2',
            login_3_label: 'Login - 3',
            tab_name: 'Name',
            tab_imagesound: 'Image/Sound',
            submit_button: 'Save',
            edit_name_title: 'Edit Name',
            input_label: 'Input',
            bg_color_label: 'Background Color',
            input_placeholder: 'Type, paste content, or select text and apply colors...',
            start_color_label: 'Start Color',
            end_color_label: 'End Color',
            gradient_preview_label: 'Gradient Preview',
            clear_color_button: 'Clear Color',
            apply_color_1_button: 'Apply Color 1',
            apply_color_2_button: 'Apply Color 2',
            create_gradient_button: 'Create Gradient',
            edit_imagesound_title: 'Edit Image/Sound',
            image_upload_label: 'Upload Image (16:9, max 1920x1080)',
            audio_upload_label: 'Upload Audio (Max 30s, .mp3)',
            choose_file_button: 'Choose File',
            no_file_chosen: 'No file chosen',
            success_message: 'Saved successfully!',
            error_main_name: 'Error: Please enter a Name at the top.',
            error_name_length: (loginNumber, length) => `Error: 'Name' content for Login ${loginNumber} (${length} chars) exceeds 100 characters.`,
            error_filename_length: (filename, loginNumber) => `Error: Filename '${filename}' (Login ${loginNumber}) exceeds 100 characters.`,
            image_error_size: (w, h) => `Error: Image size (${w}x${h}) exceeds 1920x1080.`,
            image_error_ratio: (ratio) => `Error: Image ratio (${ratio.toFixed(2)}) is not 16:9.`,
            image_error_read: 'Error: Cannot read image file.',
            image_error_invalid: 'Invalid file, please select again.',
            image_error_type: 'Error: Only .png or .jpg files are accepted.',
            audio_error_duration: (duration) => `Error: Audio is too long (${duration.toFixed(1)}s), 30s max.`,
            audio_error_read: 'Error: Cannot read audio file.',
            audio_error_type: 'Error: Only .mp3 files are accepted.'
        };

        const translations_vi = {
            main_title: 'Thông tin',
            language_label: 'Ngôn ngữ',
            main_name_label: 'Name:',
            main_name_placeholder: 'Nhập tên (tối đa 16 ký tự)',
            login_1_label: 'Login - 1',
            login_2_label: 'Login - 2',
            login_3_label: 'Login - 3',
            tab_name: 'Tên',
            tab_imagesound: 'Ảnh/Âm thanh',
            submit_button: 'Lưu',
            edit_name_title: 'Chỉnh sửa Tên',
            input_label: 'Đầu vào',
            bg_color_label: 'Màu Nền',
            input_placeholder: 'Gõ, dán nội dung, hoặc bôi đen và áp dụng màu sắc...',
            start_color_label: 'Màu Bắt đầu',
            end_color_label: 'Màu Kết thúc',
            gradient_preview_label: 'Xem trước Gradient',
            clear_color_button: 'Xóa Màu',
            apply_color_1_button: 'Áp Dụng Màu 1',
            apply_color_2_button: 'Áp Dụng Màu 2',
            create_gradient_button: 'Tạo Gradient',
            edit_imagesound_title: 'Chỉnh sửa Ảnh/Âm thanh',
            image_upload_label: 'Tải ảnh (16:9, max 1920x1080)',
            audio_upload_label: 'Tải âm thanh (Tối đa 30s, .mp3)',
            choose_file_button: 'Chọn tệp',
            no_file_chosen: 'Chưa chọn tệp',
            success_message: 'Đã lưu thành công!',
            error_main_name: 'Lỗi: Vui lòng nhập Name ở ô trên cùng.',
            error_name_length: (loginNumber, length) => `Lỗi: Nội dung 'Tên' của Login ${loginNumber} (${length} ký tự) vượt quá 100 ký tự.`,
            error_filename_length: (filename, loginNumber) => `Lỗi: Tên tệp '${filename}' (Login ${loginNumber}) quá 100 ký tự.`,
            image_error_size: (w, h) => `Lỗi: Kích thước ảnh (${w}x${h}) vượt quá 1920x1080.`,
            image_error_ratio: (ratio) => `Lỗi: Tỷ lệ ảnh (${ratio.toFixed(2)}) không phải 16:9.`,
            image_error_read: 'Lỗi: Không thể đọc tệp ảnh.',
            image_error_invalid: 'Tệp không hợp lệ, vui lòng chọn lại.',
            image_error_type: 'Lỗi: Chỉ chấp nhận tệp .png hoặc .jpg.',
            audio_error_duration: (duration) => `Lỗi: Âm thanh quá dài (${duration.toFixed(1)}s), tối đa 30s.`,
            audio_error_read: 'Lỗi: Không thể đọc tệp âm thanh.',
            audio_error_type: 'Lỗi: Chỉ chấp nhận tệp .mp3.'
        };
        
        const translations = {
            'en': translations_en,
            'vi': translations_vi,
            'id': { ...translations_en,
                main_title: 'Informasi',
                language_label: 'Bahasa',
                main_name_label: 'Nama:',
                main_name_placeholder: 'Masukkan nama (maks 16 karakter)',
                login_1_label: 'Login - 1',
                login_2_label: 'Login - 2',
                login_3_label: 'Login - 3',
                tab_name: 'Nama',
                tab_imagesound: 'Gambar/Suara',
                submit_button: 'Simpan',
                edit_name_title: 'Edit Nama',
                input_label: 'Masukan',
                bg_color_label: 'Warna Latar',
                input_placeholder: 'Ketik, tempel konten, atau pilih teks dan terapkan warna...',
                start_color_label: 'Warna Awal',
                end_color_label: 'Warna Akhir',
                gradient_preview_label: 'Pratinjau Gradien',
                clear_color_button: 'Hapus Warna',
                apply_color_1_button: 'Terapkan Warna 1',
                apply_color_2_button: 'Terapkan Warna 2',
                create_gradient_button: 'Buat Gradien',
                edit_imagesound_title: 'Edit Gambar/Suara',
                image_upload_label: 'Unggah Gambar (16:9, maks 1920x1080)',
                audio_upload_label: 'Unggah Audio (Maks 30d, .mp3)',
                choose_file_button: 'Pilih File',
                no_file_chosen: 'Tidak ada file yang dipilih',
                success_message: 'Berhasil disimpan!',
                error_main_name: 'Error: Harap masukkan Nama di atas.',
                error_name_length: (loginNumber, length) => `Error: Konten 'Nama' untuk Login ${loginNumber} (${length} karakter) melebihi 100 karakter.`,
                error_filename_length: (filename, loginNumber) => `Error: Nama file '${filename}' (Login ${loginNumber}) melebihi 100 karakter.`,
                image_error_size: (w, h) => `Error: Ukuran gambar (${w}x${h}) melebihi 1920x1080.`,
                image_error_ratio: (ratio) => `Error: Rasio gambar (${ratio.toFixed(2)}) bukan 16:9.`,
                image_error_read: 'Error: Tidak dapat membaca file gambar.',
                image_error_invalid: 'File tidak valid, silakan pilih lagi.',
                image_error_type: 'Error: Hanya file .png atau .jpg yang diterima.',
                audio_error_duration: (duration) => `Error: Audio terlalu panjang (${duration.toFixed(1)}d), maks 30d.`,
                audio_error_read: 'Error: Tidak dapat membaca file audio.',
                audio_error_type: 'Error: Hanya file .mp3 yang diterima.'
            },
            'ru': { ...translations_en,
                main_title: 'Информация',
                language_label: 'Язык',
                main_name_label: 'Имя:',
                main_name_placeholder: 'Введите имя (макс. 16 симв.)',
                login_1_label: 'Логин - 1',
                login_2_label: 'Логин - 2',
                login_3_label: 'Логин - 3',
                tab_name: 'Имя',
                tab_imagesound: 'Изобр./Звук',
                submit_button: 'Сохранить',
                edit_name_title: 'Редакт. Имя',
                input_label: 'Ввод',
                bg_color_label: 'Цвет фона',
                input_placeholder: 'Введите, вставьте контент или выберите текст и примените цвета...',
                start_color_label: 'Начальный цвет',
                end_color_label: 'Конечный цвет',
                gradient_preview_label: 'Предпросмотр градиента',
                clear_color_button: 'Очистить цвет',
                apply_color_1_button: 'Применить цвет 1',
                apply_color_2_button: 'Применить цвет 2',
                create_gradient_button: 'Создать градиент',
                edit_imagesound_title: 'Редакт. Изобр./Звук',
                image_upload_label: 'Загрузить изображение (16:9, макс. 1920x1080)',
                audio_upload_label: 'Загрузить аудио (Макс. 30с, .mp3)',
                choose_file_button: 'Выберите файл',
                no_file_chosen: 'Файл не выбран',
                success_message: 'Успешно сохранено!',
                error_main_name: 'Ошибка: Пожалуйста, введите Имя вверху.',
                error_name_length: (loginNumber, length) => `Ошибка: Содержимое 'Имя' для Логина ${loginNumber} (${length} симв.) превышает 100 символов.`,
                error_filename_length: (filename, loginNumber) => `Ошибка: Имя файла '${filename}' (Логин ${loginNumber}) превышает 100 символов.`,
                image_error_size: (w, h) => `Ошибка: Размер изображения (${w}x${h}) превышает 1920x1080.`,
                image_error_ratio: (ratio) => `Ошибка: Соотношение сторон (${ratio.toFixed(2)}) не 16:9.`,
                image_error_read: 'Ошибка: Невозможно прочитать файл изображения.',
                image_error_invalid: 'Неверный файл, выберите еще раз.',
                image_error_type: 'Ошибка: Принимаются только файлы .png или .jpg.',
                audio_error_duration: (duration) => `Ошибка: Аудио слишком длинное (${duration.toFixed(1)}с), макс. 30с.`,
                audio_error_read: 'Ошибка: Невозможно прочитать аудиофайл.',
                audio_error_type: 'Ошибка: Принимаются только файлы .mp3.'
            },
            'th': { ...translations_en,
                main_title: 'ข้อมูล',
                language_label: 'ภาษา',
                main_name_label: 'ชื่อ:',
                main_name_placeholder: 'ป้อนชื่อ (สูงสุด 16 ตัวอักษร)',
                login_1_label: 'ล็อกอิน - 1',
                login_2_label: 'ล็อกอิน - 2',
                login_3_label: 'ล็อกอิน - 3',
                tab_name: 'ชื่อ',
                tab_imagesound: 'รูปภาพ/เสียง',
                submit_button: 'บันทึก',
                edit_name_title: 'แก้ไขชื่อ',
                input_label: 'อินพุต',
                bg_color_label: 'สีพื้นหลัง',
                input_placeholder: 'พิมพ์ วางเนื้อหา หรือเลือกข้อความและใช้สี...',
                start_color_label: 'สีเริ่มต้น',
                end_color_label: 'สีสิ้นสุด',
                gradient_preview_label: 'ตัวอย่างการไล่ระดับสี',
                clear_color_button: 'ล้างสี',
                apply_color_1_button: 'ใช้สี 1',
                apply_color_2_button: 'ใช้สี 2',
                create_gradient_button: 'สร้างการไล่ระดับสี',
                edit_imagesound_title: 'แก้ไขรูปภาพ/เสียง',
                image_upload_label: 'อัปโหลดรูปภาพ (16:9, สูงสุด 1920x1080)',
                audio_upload_label: 'อัปโหลดเสียง (สูงสุด 30 วินาที, .mp3)',
                choose_file_button: 'เลือกไฟล์',
                no_file_chosen: 'ยังไม่ได้เลือกไฟล์',
                success_message: 'บันทึกสำเร็จ!',
                error_main_name: 'ข้อผิดพลาด: กรุณาป้อนชื่อที่ด้านบน',
                error_name_length: (loginNumber, length) => `ข้อผิดพลาด: เนื้อหา 'ชื่อ' สำหรับล็อกอิน ${loginNumber} (${length} ตัวอักษร) เกิน 100 ตัวอักษร`,
                error_filename_length: (filename, loginNumber) => `ข้อผิดพลาด: ชื่อไฟล์ '${filename}' (ล็อกอิน ${loginNumber}) เกิน 100 ตัวอักษร`,
                image_error_size: (w, h) => `ข้อผิดพลาด: ขนาดรูปภาพ (${w}x${h}) เกิน 1920x1080`,
                image_error_ratio: (ratio) => `ข้อผิดพลาด: อัตราส่วนภาพ (${ratio.toFixed(2)}) ไม่ใช่ 16:9`,
                image_error_read: 'ข้อผิดพลาด: ไม่สามารถอ่านไฟล์รูปภาพได้',
                image_error_invalid: 'ไฟล์ไม่ถูกต้อง โปรดเลือกใหม่',
                image_error_type: 'ข้อผิดพลาด: รับเฉพาะไฟล์ .png หรือ .jpg เท่านั้น',
                audio_error_duration: (duration) => `ข้อผิดพลาด: ไฟล์เสียงยาวเกินไป (${duration.toFixed(1)} วินาที), สูงสุด 30 วินาที`,
                audio_error_read: 'ข้อผิดพลาด: ไม่สามารถอ่านไฟล์เสียงได้',
                audio_error_type: 'ข้อผิดพลาด: รับเฉพาะไฟล์ .mp3 เท่านั้น'
            },
            'ko': { ...translations_en,
                main_title: '정보',
                language_label: '언어',
                main_name_label: '이름:',
                main_name_placeholder: '이름 입력 (최대 16자)',
                login_1_label: '로그인 - 1',
                login_2_label: '로그인 - 2',
                login_3_label: '로그인 - 3',
                tab_name: '이름',
                tab_imagesound: '이미지/사운드',
                submit_button: '저장',
                edit_name_title: '이름 편집',
                input_label: '입력',
                bg_color_label: '배경색',
                input_placeholder: '내용을 입력, 붙여넣기하거나 텍스트를 선택하여 색상을 적용하세요...',
                start_color_label: '시작 색상',
                end_color_label: '끝 색상',
                gradient_preview_label: '그라데이션 미리보기',
                clear_color_button: '색상 지우기',
                apply_color_1_button: '색상 1 적용',
                apply_color_2_button: '색상 2 적용',
                create_gradient_button: '그라데이션 생성',
                edit_imagesound_title: '이미지/사운드 편집',
                image_upload_label: '이미지 업로드 (16:9, 최대 1920x1080)',
                audio_upload_label: '오디오 업로드 (최대 30초, .mp3)',
                choose_file_button: '파일 선택',
                no_file_chosen: '선택된 파일 없음',
                success_message: '성공적으로 저장되었습니다!',
                error_main_name: '오류: 상단에 이름을 입력하세요.',
                error_name_length: (loginNumber, length) => `오류: 로그인 ${loginNumber}의 '이름' 내용(${length}자)이 100자를 초과합니다.`,
                error_filename_length: (filename, loginNumber) => `오류: 파일 이름 '${filename}'(로그인 ${loginNumber})이 100자를 초과합니다.`,
                image_error_size: (w, h) => `오류: 이미지 크기(${w}x${h})가 1920x1080을 초과합니다.`,
                image_error_ratio: (ratio) => `오류: 이미지 비율(${ratio.toFixed(2)})이 16:9가 아닙니다.`,
                image_error_read: '오류: 이미지 파일을 읽을 수 없습니다.',
                image_error_invalid: '잘못된 파일입니다. 다시 선택하세요.',
                image_error_type: '오류: .png 또는 .jpg 파일만 허용됩니다.',
                audio_error_duration: (duration) => `오류: 오디오가 너무 깁니다(${duration.toFixed(1)}초). 최대 30초.`,
                audio_error_read: '오류: 오디오 파일을 읽을 수 없습니다.',
                audio_error_type: '오류: .mp3 파일만 허용됩니다.'
            }
        };

        let currentLang = 'vi';

        function updateUI(lang) {
            currentLang = lang;
            const t = translations[lang] || translations_en;

            document.documentElement.lang = lang;
            
            document.getElementById('main-title').textContent = t.main_title;
            document.getElementById('language-label').textContent = t.language_label;
            document.getElementById('main-name-label').textContent = t.main_name_label;
            document.getElementById('name').setAttribute('placeholder', t.main_name_placeholder);
            
            document.getElementById('login-1-label').textContent = t.login_1_label;
            document.getElementById('login-2-label').textContent = t.login_2_label;
            document.getElementById('login-3-label').textContent = t.login_3_label;

            document.querySelectorAll('[data-translate-key="tab_name"]').forEach(el => el.textContent = t.tab_name);
            document.querySelectorAll('[data-translate-key="tab_imagesound"]').forEach(el => el.textContent = t.tab_imagesound);
            
            document.getElementById('submit-button').textContent = t.submit_button;
            document.getElementById('edit-name-title').textContent = t.edit_name_title;
            document.getElementById('input-label').textContent = t.input_label;
            document.getElementById('bg-color-label').textContent = t.bg_color_label;
            document.getElementById('input-editor').setAttribute('data-placeholder', t.input_placeholder);
            document.getElementById('start-color-label').textContent = t.start_color_label;
            document.getElementById('end-color-label').textContent = t.end_color_label;
            document.getElementById('gradient-preview-label').textContent = t.gradient_preview_label;
            document.getElementById('clear-color-button').textContent = t.clear_color_button;
            document.getElementById('apply-color-button').textContent = t.apply_color_1_button;
            document.getElementById('apply-color-button-2').textContent = t.apply_color_2_button;
            document.getElementById('apply-gradient-button').textContent = t.create_gradient_button;
            
            document.getElementById('edit-imagesound-title').textContent = t.edit_imagesound_title;
            document.getElementById('image-upload-label').textContent = t.image_upload_label;
            document.getElementById('audio-upload-label').textContent = t.audio_upload_label;

            document.querySelectorAll('[data-translate-key="choose_file_button"]').forEach(el => {
                el.textContent = t.choose_file_button;
                el.setAttribute('aria-label', t.choose_file_button);
            });
            
            updateFileName('image-input', 'image-file-name');
            updateFileName('audio-input', 'audio-file-name');
        }

        function updateFileName(inputId, labelId) {
            const input = document.getElementById(inputId);
            const label = document.getElementById(labelId);
            const t = translations[currentLang] || translations_en;

            if (input.files.length > 0) {
                label.textContent = input.files[0].name;
            } else {
                label.textContent = t.no_file_chosen;
            }
        }


        const imageInput = document.getElementById('image-input');
        const imagePreview = document.getElementById('image-preview');
        const imageErrorMsg = document.getElementById('image-error-msg');
        
        const audioInput = document.getElementById('audio-input');
        const audioPreview = document.getElementById('audio-preview');
        const audioErrorMsg = document.getElementById('audio-error-msg');

        async function convertCanvasToTgaBlob(canvas) {
            const ctx = canvas.getContext('2d', { willReadFrequently: true });
            const width = canvas.width;
            const height = canvas.height;
            const imageData = ctx.getImageData(0, 0, width, height);
            const data = imageData.data; 

            const header = new Uint8Array(18);
            header.fill(0);
            header[2] = 10; 
            header[12] = width & 0xFF;
            header[13] = (width >> 8) & 0xFF;
            header[14] = height & 0xFF;
            header[15] = (height >> 8) & 0xFF;
            header[16] = 24; 
            header[17] = 0x20; 

            const pixels = [];
            for (let i = 0; i < data.length; i += 4) {
                pixels.push(data[i + 2]); 
                pixels.push(data[i + 1]); 
                pixels.push(data[i + 0]); 
            }

            const rleData = [];
            let i = 0;
            const pixelCount = width * height;
            
            while (i < pixels.length) {
                let runLength = 1;
                let isRunPacket = true;
                
                while (i + runLength * 3 < pixels.length && runLength < 128) {
                    if (pixels[i] !== pixels[i + runLength * 3] ||
                        pixels[i + 1] !== pixels[i + runLength * 3 + 1] ||
                        pixels[i + 2] !== pixels[i + runLength * 3 + 2]) {
                        break;
                    }
                    runLength++;
                }

                if (runLength > 1) {
                    rleData.push(0x80 | (runLength - 1)); 
                    rleData.push(pixels[i], pixels[i + 1], pixels[i + 2]); 
                    i += runLength * 3;
                } else {
                    let rawLength = 1;
                    while (i + rawLength * 3 < pixels.length && rawLength < 128) {
                        if (i + (rawLength + 1) * 3 < pixels.length &&
                            pixels[i + rawLength * 3] === pixels[i + (rawLength + 1) * 3] &&
                            pixels[i + rawLength * 3 + 1] === pixels[i + (rawLength + 1) * 3 + 1] &&
                            pixels[i + rawLength * 3 + 2] === pixels[i + (rawLength + 1) * 3 + 2]) {
                            break; 
                        }
                        rawLength++;
                    }
                    
                    rleData.push(rawLength - 1); 
                    for (let k = 0; k < rawLength; k++) {
                        rleData.push(pixels[i + k * 3]);
                        rleData.push(pixels[i + k * 3 + 1]);
                        rleData.push(pixels[i + k * 3 + 2]);
                    }
                    i += rawLength * 3;
                }
            }

            const tgaFile = new Uint8Array(header.length + rleData.length);
            tgaFile.set(header);
            tgaFile.set(rleData, header.length);

            return new Blob([tgaFile], { type: 'image/tga' });
        }

        function saveCurrentContext() {
            if (!currentActiveContext) return;
            const { number, type } = currentActiveContext;

            if (type === 'name' && inputEditor) {
                loginData[number].name = inputEditor.innerHTML;
                
                if (window.updateOutput) window.updateOutput(); 
                const outputEditor = document.getElementById('output-editor');
                if (outputEditor) {
                    loginData[number].output = outputEditor.textContent;
                }
            }
        }

        function toggleLoginTabs(loginNumber) {
            const tabsToToggle = document.getElementById(`tabs-login-${loginNumber}`);
            const arrowToToggle = document.getElementById(`loginArrow-${loginNumber}`);
            
            const isOpening = tabsToToggle.classList.contains('hidden');
            const previousContext = currentActiveContext ? { ...currentActiveContext } : null; 

            if (!isOpening && previousContext && previousContext.number === loginNumber) {
                saveCurrentContext();
                currentActiveContext = null;
                loginPanel.classList.add('hidden');
                imageSoundPanel.classList.add('hidden');
                setActiveTab(null);
            } 
            else if (isOpening && previousContext) {
                saveCurrentContext();
            }

            allTabContainers.forEach(container => container.classList.add('hidden'));
            allLoginArrows.forEach(arrow => arrow.classList.remove('rotate-180'));

            if (isOpening) {
                tabsToToggle.classList.remove('hidden');
                arrowToToggle.classList.add('rotate-180');

                if (previousContext && previousContext.number !== loginNumber) {
                    if (previousContext.type === 'name') {
                        showColorPanel(loginNumber);
                    } else if (previousContext.type === 'imagesound') {
                        showImageSoundPanel(loginNumber);
                    }
                }
            }
        }
        
        function setActiveTab(activeId) {
            allTabButtons.forEach(button => {
                button.classList.remove('active-tab');
                button.classList.add('tab-btn');
            });

            if (activeId) {
                const activeButton = document.getElementById(activeId);
                if (activeButton) {
                    activeButton.classList.remove('tab-btn');
                    activeButton.classList.add('active-tab');
                }
            }
        }

        function showColorPanel(loginNumber) {
            saveCurrentContext();
            currentActiveContext = { number: loginNumber, type: 'name' };

            if (inputEditor) {
                inputEditor.innerHTML = loginData[loginNumber].name;
                if (window.updateOutput) {
                    window.updateOutput(); 
                }
            }

            imageSoundPanel.classList.add('hidden');
            loginPanel.classList.remove('hidden');
            setActiveTab(`tab-name-${loginNumber}`);
        }

        function showImageSoundPanel(loginNumber) {
            saveCurrentContext();
            currentActiveContext = { number: loginNumber, type: 'imagesound' };
            
            loadMediaState(loginNumber); 

            loginPanel.classList.add('hidden');
            imageSoundPanel.classList.remove('hidden');
            setActiveTab(`tab-imagesound-${loginNumber}`);
        }

        function loadMediaState(loginNumber) {
            const data = loginData[loginNumber];
            const t = translations[currentLang] || translations_en;

            if (data.imageUrl) {
                imagePreview.src = data.imageUrl;
                imagePreview.classList.remove('hidden');
            } else {
                imagePreview.src = '';
                imagePreview.classList.add('hidden');
            }
            document.getElementById('image-file-name').textContent = data.imageName || t.no_file_chosen;
            imageErrorMsg.textContent = ''; 
            imageInput.value = ''; 

            if (data.audioUrl) {
                audioPreview.src = data.audioUrl;
                audioPreview.classList.remove('hidden');
            } else {
                audioPreview.src = '';
                audioPreview.classList.add('hidden');
            }
            document.getElementById('audio-file-name').textContent = data.audioName || t.no_file_chosen;
            audioErrorMsg.textContent = ''; 
            audioInput.value = ''; 
        }

        function showMessage(text, isError = false) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            if (isError) {
                messageEl.classList.remove('text-green-600');
                messageEl.classList.add('text-red-600');
            } else {
                messageEl.classList.add('text-green-600');
                messageEl.classList.remove('text-red-600');
            }
            setTimeout(() => { 
                messageEl.textContent = ''; 
                messageEl.classList.remove('text-red-600');
                messageEl.classList.add('text-green-600');
            }, 3000);
        }

        function handleSubmit(event) {
            event.preventDefault(); 
            const t = translations[currentLang] || translations_en;
            
            saveCurrentContext();

            const mainNameValue = document.getElementById('name').value;
            if (!mainNameValue) {
                showMessage(t.error_main_name, true);
                return;
            }

            let fileContent = `if CurLog=="${mainNameValue}" then\n`;
            const zip = new JSZip();
            const folder = zip.folder("Title"); 
            let hasFiles = false; 

            for (let i = 1; i <= 3; i++) {
                const data = loginData[i];
                
                const outputText = data.output ? data.output.trim() : '';
                if (outputText.length > 100) {
                    showMessage(t.error_name_length(i, outputText.length), true);
                    return; 
                }

                const hasName = outputText !== '';
                const hasSound = !!data.audioFile; 
                const hasImage = !!data.imageFile; 
                
                if (hasSound) {
                    const audExt = data.audioFile.name.split('.').pop() || 'mp3';
                    const newAudioName = `${mainNameValue}${i}.${audExt}`;
                    if (newAudioName.length > 100) {
                        showMessage(t.error_filename_length(newAudioName, i), true);
                        return; 
                    }
                }
                if (hasImage) {
                    const imgExt = 'tga';
                    const newImageName = `${mainNameValue}${i}.${imgExt}`;
                    if (newImageName.length > 100) {
                        showMessage(t.error_filename_length(newImageName, i), true);
                        return; 
                    }
                }

                if (hasName || hasSound || hasImage) {
                    fileContent += `if str=="-login${i === 1 ? '' : i}" then\n`;
                    hasFiles = true; 
                    
                    if (hasName) {
                        const safeOutput = outputText.replace(/"/g, '\\"');
                        fileContent += `call SetPlayerName(p,"${safeOutput}")\n`; 
                    }
                    if (hasSound) {
                        const audExt = data.audioFile.name.split('.').pop() || 'mp3';
                        const newAudioName = `${mainNameValue}${i}.${audExt}`;
                        
                        fileContent += `call PlaySoundEx("Title\\\\${newAudioName}",270)\n`;
                        folder.file(newAudioName, data.audioFile);
                    }
                    if (hasImage) {
                        const imgExt = 'tga';
                        const newImageName = `${mainNameValue}${i}.${imgExt}`;
                        
                        fileContent += `call CinematicFilterGenericBJ(3.,BLEND_MODE_BLEND,"Title\\\\${newImageName}",100.,100,100,0.,100.,100.,100.,100.)\n`;
                        folder.file(newImageName, data.imageFile);
                    }
                    fileContent += `endif\n`;
                }
            }

            fileContent += `endif\n`;

            if (hasFiles) {
                zip.file("Name.txt", fileContent);
            } else {
                 zip.file("Name.txt", fileContent);
            }

            zip.generateAsync({ type: "blob" })
               .then(function(content) {
                   downloadBlob(content, `${mainNameValue}.zip`);
               });

            showMessage(t.success_message, false);
            
            loginPanel.classList.add('hidden');
            imageSoundPanel.classList.add('hidden');
            allTabContainers.forEach(container => container.classList.add('hidden'));
            allLoginArrows.forEach(arrow => arrow.classList.remove('rotate-180'));
            setActiveTab(null);

            for (let i = 1; i <= 3; i++) {
                if (loginData[i].imageUrl && loginData[i].imageUrl.startsWith('blob:')) {
                    URL.revokeObjectURL(loginData[i].imageUrl);
                }
                if (loginData[i].audioUrl && loginData[i].audioUrl.startsWith('blob:')) {
                    URL.revokeObjectURL(loginData[i].audioUrl);
                }
            }

            loginData = {
                1: { name: '', output: '', imageUrl: null, imageFile: null, audioUrl: null, audioFile: null, imageName: '', audioName: '' },
                2: { name: '', output: '', imageUrl: null, imageFile: null, audioUrl: null, audioFile: null, imageName: '', audioName: '' },
                3: { name: '', output: '', imageUrl: null, imageFile: null, audioUrl: null, audioFile: null, imageName: '', audioName: '' }
            };
            currentActiveContext = null;
            
            if (inputEditor) {
                inputEditor.innerHTML = ''; 
                if (window.updateOutput) window.updateOutput();
            }
            loadMediaState(1); 
            updateFileName('image-input', 'image-file-name');
            updateFileName('audio-input', 'audio-file-name');

            document.getElementById('infoForm').reset(); 
        }

        function downloadBlob(blob, fileName) {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(a.href);
        }


        function handleStandardImageUpload(file, number, objectUrl) {
            const t = translations[currentLang] || translations_en;
            const img = new Image();
            img.onload = async () => {
                const w = img.width;
                const h = img.height;
                const ratio = w / h;
                const expectedRatio = 16 / 9;
                let valid = true;

                if (w > 1920 || h > 1080) {
                    imageErrorMsg.textContent = t.image_error_size(w, h);
                    valid = false;
                }
                
                if (Math.abs(ratio - expectedRatio) > 0.02) { 
                    imageErrorMsg.textContent = t.image_error_ratio(ratio);
                    valid = false;
                }

                if (valid) {
                    const canvas = document.createElement('canvas');
                    canvas.width = w;
                    canvas.height = h;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);

                    const tgaBlob = await convertCanvasToTgaBlob(canvas);

                    imagePreview.src = objectUrl; 
                    imagePreview.classList.remove('hidden');
                    loginData[number].imageUrl = objectUrl; 
                    loginData[number].imageFile = tgaBlob; 
                    loginData[number].imageName = file.name; 
                    updateFileName('image-input', 'image-file-name');
                } else {
                    URL.revokeObjectURL(objectUrl);
                    imageInput.value = ''; 
                    imageErrorMsg.textContent = t.image_error_invalid;
                }
            };

            img.onerror = () => {
                 imageErrorMsg.textContent = t.image_error_read;
                 updateFileName('image-input', 'image-file-name');
                 URL.revokeObjectURL(objectUrl);
                 imageInput.value = '';
            };
            
            img.src = objectUrl;
        }


        function handleImageUpload(e) {
            if (!currentActiveContext || currentActiveContext.type !== 'imagesound') return;
            const t = translations[currentLang] || translations_en;
            
            const file = e.target.files[0];
            const { number } = currentActiveContext;

            imageErrorMsg.textContent = '';
            imagePreview.classList.add('hidden');
            
            if (loginData[number].imageUrl && loginData[number].imageUrl.startsWith('blob:')) {
                URL.revokeObjectURL(loginData[number].imageUrl);
            }
            
            loginData[number].imageUrl = null;
            loginData[number].imageFile = null; 
            loginData[number].imageName = '';
            
            if (!file) {
                updateFileName('image-input', 'image-file-name');
                return;
            }

            const allowedTypes = ['image/png', 'image/jpeg'];
            
            if (allowedTypes.includes(file.type)) {
                const objectUrl = URL.createObjectURL(file);
                handleStandardImageUpload(file, number, objectUrl);
            } else {
                imageErrorMsg.textContent = t.image_error_type;
                updateFileName('image-input', 'image-file-name');
                imageInput.value = ''; 
            }
        }

        function handleAudioUpload(e) {
            if (!currentActiveContext || currentActiveContext.type !== 'imagesound') return;
            const t = translations[currentLang] || translations_en;

            const file = e.target.files[0];
            const { number } = currentActiveContext;

            audioPreview.classList.add('hidden');
            audioPreview.src = '';
            audioErrorMsg.textContent = ''; 

            if (loginData[number].audioUrl) {
                URL.revokeObjectURL(loginData[number].audioUrl);
            }
            loginData[number].audioUrl = null;
            loginData[number].audioFile = null; 
            loginData[number].audioName = '';
            
            if (!file) {
                updateFileName('audio-input', 'audio-file-name');
                return;
            }

            if (file.type !== 'audio/mpeg') {
                audioErrorMsg.textContent = t.audio_error_type;
                updateFileName('audio-input', 'audio-file-name');
                audioInput.value = '';
                return;
            }

            const objectUrl = URL.createObjectURL(file);

            const audio = document.createElement('audio');
            
            audio.addEventListener('loadedmetadata', () => {
                const duration = audio.duration;
                if (duration > 30) {
                    audioErrorMsg.textContent = t.audio_error_duration(duration);
                    URL.revokeObjectURL(objectUrl); 
                    audioInput.value = ''; 
                    updateFileName('audio-input', 'audio-file-name');
                } else {
                    audioErrorMsg.textContent = ''; 
                    audioPreview.src = objectUrl;
                    audioPreview.classList.remove('hidden');
                    loginData[number].audioUrl = objectUrl; 
                    loginData[number].audioFile = file; 
                    loginData[number].audioName = file.name;
                    updateFileName('audio-input', 'audio-file-name');
                }
            });
            
            audio.addEventListener('error', () => {
                audioErrorMsg.textContent = t.audio_error_read;
                URL.revokeObjectURL(objectUrl);
                audioInput.value = '';
                updateFileName('audio-input', 'audio-file-name');
            });
            
            audio.src = objectUrl; 
        }

        let globalInputEditor; 

        function initializeWarcraftConverter() {
            globalInputEditor = document.getElementById('input-editor'); 
            if (!globalInputEditor) return; 

            const outputEditor = document.getElementById('output-editor');
            const colorPicker = document.getElementById('color-picker');
            const applyColorButton = document.getElementById('apply-color-button');
            const colorPicker2 = document.getElementById('color-picker-2');
            const applyColorButton2 = document.getElementById('apply-color-button-2');
            const applyGradientButton = document.getElementById('apply-gradient-button');
            const gradientDisplay = document.getElementById('gradient-display');
            const clearColorButton = document.getElementById('clear-color-button');
            const outputContainer = document.getElementById('output-container'); 
            const bgColorPicker = document.getElementById('bg-color-picker');

            globalInputEditor.style.backgroundColor = bgColorPicker.value;
            
            function parseNodeToObjects(node, dataArray, defaultColor) {
                const localInputEditor = globalInputEditor || document.getElementById('input-editor');
                if (node.nodeType === Node.TEXT_NODE) {
                    const text = node.textContent;
                    if (text.length === 0) return; 

                    let color = defaultColor; 
                    let parent = node.parentElement;
                    
                    while (parent && parent !== localInputEditor) {
                        if (parent.nodeName === 'SPAN' && parent.style.color) {
                            color = parent.style.color; 
                            break;
                        }
                        if (parent.nodeName === 'FONT' && parent.getAttribute('color')) {
                            color = parent.getAttribute('color'); 
                            break;
                        }
                        parent = parent.parentElement;
                    }
                    
                    dataArray.push({
                        Color: color, 
                        Text: text 
                    });

                } 
                else if (node.nodeType === Node.ELEMENT_NODE) {
                    if (node.nodeName === 'BR' || (node.nodeName === 'DIV' && node.childNodes.length === 0)) {
                            if (dataArray.length > 0 && dataArray[dataArray.length - 1].Text !== '\n') {
                                dataArray.push({ Color: defaultColor, Text: '\n' });
                            }
                    } else if (node.nodeName === 'DIV') {
                            if (dataArray.length > 0 && dataArray[dataArray.length - 1].Text !== '\n') {
                                dataArray.push({ Color: defaultColor, Text: '\n' });
                            }
                            node.childNodes.forEach(child => parseNodeToObjects(child, dataArray, defaultColor));
                    }
                    else {
                        node.childNodes.forEach(child => parseNodeToObjects(child, dataArray, defaultColor));
                    }
                }
            }

            function rgbToHex(rgb) {
                if (rgb.startsWith('#')) {
                    return rgb.substring(1).toUpperCase();
                }
                
                const match = rgb.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
                
                if (!match) return '000000'; 

                const toHex = (c) => {
                    const num = Number(c);
                    const hex = num.toString(16);
                    return hex.length == 1 ? "0" + hex : hex;
                };

                const r = toHex(match[1]);
                const g = toHex(match[2]);
                const b = toHex(match[3]);
                
                return `${r}${g}${b}`.toUpperCase();
            }

            function lerp(a, b, t) {
                return a + (b - a) * t;
            }

            function hexToRgb(hex) {
                let r = 0, g = 0, b = 0;
                if (hex.length == 7) {
                    r = parseInt(hex.substring(1, 3), 16);
                    g = parseInt(hex.substring(3, 5), 16);
                    b = parseInt(hex.substring(5, 7), 16);
                }
                return { r, g, b };
            }
            
            function escapeHtml(text) {
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#03S9;'
                };
                return text.replace(/[&<>"']/g, (m) => map[m] || m); 
            }

            function updateGradientDisplay() {
                if (!colorPicker || !colorPicker2 || !gradientDisplay) return;
                const color1 = colorPicker.value;
                const color2 = colorPicker2.value;
                gradientDisplay.style.background = `linear-gradient(to right, ${color1}, ${color2})`;
            }

            window.updateOutput = function() {
                const localInputEditor = globalInputEditor || document.getElementById('input-editor');
                if (!localInputEditor || !outputEditor) return;

                const dataArray = [];
                const defaultEditorColor = window.getComputedStyle(localInputEditor).color; 
                const defaultEditorHex = rgbToHex(defaultEditorColor);

                localInputEditor.childNodes.forEach(node => parseNodeToObjects(node, dataArray, defaultEditorColor));
                
                while (dataArray.length > 0 && dataArray[dataArray.length - 1].Text === '\n') {
                    const lastNode = localInputEditor.childNodes[localInputEditor.childNodes.length - 1];
                    if (lastNode && (lastNode.nodeName === 'DIV' || lastNode.nodeName === 'BR') && !lastNode.textContent) {
                            dataArray.pop();
                    } else {
                            break;
                    }
                }
                
                const hasVisibleContent = dataArray.some(item => !/^\s*$/.test(item.Text));

                if (!hasVisibleContent) {
                        outputEditor.textContent = '';
                        return;
                }
                
                let outputString = '';
                let lastHexColor = ''; 

                for (const item of dataArray) {
                    const text = item.Text;
                    
                    if (text === '\n') {
                        if (lastHexColor && lastHexColor !== defaultEditorHex) {
                            outputString += '|r';
                        }
                        outputString += '|n';
                        lastHexColor = ''; 
                    } else {
                        const hexColor = rgbToHex(item.Color); 
                        const isDefaultColor = (hexColor === defaultEditorHex);
                        const isWhitespace = /^\s+$/.test(text);

                        if (isWhitespace) {
                            outputString += text;
                        }
                        else if (hexColor !== lastHexColor) {
                            if (isDefaultColor) {
                                if (lastHexColor && lastHexColor !== defaultEditorHex) {
                                        outputString += '|r';
                                }
                            } 
                            else {
                                outputString += `|cff${hexColor}`;
                            }
                            lastHexColor = hexColor;
                            outputString += text;
                        } else {
                            outputString += text;
                        }
                    }
                }
                
                if (lastHexColor && lastHexColor !== defaultEditorHex) {
                    outputString += '|r';
                }

                outputEditor.textContent = outputString;
            }

            globalInputEditor.addEventListener('input', window.updateOutput);
            globalInputEditor.addEventListener('keyup', window.updateOutput);
            globalInputEditor.addEventListener('mouseup', window.updateOutput);
            
            function convertAnsiToHtml(text) {
                let html = '';
                const parts = text.split(/(\|(?:c(?:ff)?[0-9a-fA-F]{6}|r|n))/g);
                
                let currentColor = ''; 

                for (const part of parts) {
                    if (part.startsWith('|c') && part.length === 8) {
                        const hex = part.substring(2);
                        if (currentColor) { html += '</span>'; }
                        html += `<span style="color: #${hex};">`;
                        currentColor = hex;
                    } 
                    else if (part.startsWith('|cff') && part.length === 10) {
                        const hex = part.substring(4); 
                        if (currentColor) { html += '</span>'; }
                        html += `<span style="color: #${hex};">`;
                        currentColor = hex;
                    }
                    else if (part === '|r') {
                        if (currentColor) { html += '</span>'; }
                        currentColor = '';
                    } else if (part === '|n') {
                        if (currentColor) { html += '</span>'; }
                        html += '<br>';
                        currentColor = ''; 
                    } else if (part) {
                        html += escapeHtml(part);
                    }
                }
                
                if (currentColor) {
                    html += '</span>';
                }
                return html;
            }

            globalInputEditor.addEventListener('paste', (e) => {
                e.preventDefault();
                const text = (e.clipboardData || window.clipboardData).getData('text/plain');
                
                if (text) {
                    if (text.includes('|c') || text.includes('|r') || text.includes('|n')) {
                        const html = convertAnsiToHtml(text);
                        document.execCommand('insertHTML', false, html);
                    } else {
                        document.execCommand('insertText', false, text);
                    }
                }
            });

            
            colorPicker.addEventListener('input', updateGradientDisplay);
            colorPicker2.addEventListener('input', updateGradientDisplay);

            bgColorPicker.addEventListener('input', () => {
                globalInputEditor.style.backgroundColor = bgColorPicker.value;
            });

            clearColorButton.addEventListener('mousedown', (e) => {
                e.preventDefault(); 
                globalInputEditor.focus();
                document.execCommand('removeFormat', false, null);
                setTimeout(window.updateOutput, 1);
            });
            
            applyColorButton.addEventListener('mousedown', (e) => {
                e.preventDefault(); 
                const color = colorPicker.value;
                globalInputEditor.focus();
                document.execCommand('foreColor', false, color);
                setTimeout(window.updateOutput, 1); 
            });
            
            applyColorButton2.addEventListener('mousedown', (e) => {
                e.preventDefault(); 
                const color = colorPicker2.value; 
                globalInputEditor.focus();
                document.execCommand('foreColor', false, color);
                setTimeout(window.updateOutput, 1);
            });
            
            applyGradientButton.addEventListener('mousedown', (e) => {
                e.preventDefault();
                const sel = window.getSelection();
                if (!sel.rangeCount || !globalInputEditor.contains(sel.getRangeAt(0).commonAncestorContainer)) return;

                const range = sel.getRangeAt(0);
                
                const textForCounting = range.toString();
                const nonWhitespaceChars = Array.from(textForCounting).filter(c => !/^\s*$/.test(c));
                const n = nonWhitespaceChars.length;
                if (n === 0) return; 

                const startRgb = hexToRgb(colorPicker.value);
                const endRgb = hexToRgb(colorPicker2.value);

                const fragment = range.cloneContents();
                let charIndex = 0; 

                function traverseAndColor(node) {
                    if (node.nodeType === Node.TEXT_NODE) {
                        const text = node.textContent;
                        if (text.length === 0) return;

                        const newParent = document.createDocumentFragment(); 
                        const chars = Array.from(text); 

                        for (const char of chars) {
                            if (/^\s*$/.test(char)) {
                                newParent.appendChild(document.createTextNode(char));
                            } else {
                                const t = (n <= 1) ? 0.5 : charIndex / (n - 1);
                                charIndex++; 

                                const r = Math.round(lerp(startRgb.r, endRgb.r, t));
                                const g = Math.round(lerp(startRgb.g, endRgb.g, t));
                                const b = Math.round(lerp(startRgb.b, endRgb.b, t));

                                const hexValue = [r, g, b].map(c => {
                                    const hex = c.toString(16);
                                    return hex.length == 1 ? "0" + hex : hex;
                                }).join('');
                                
                                const span = document.createElement('span');
                                span.style.color = `#${hexValue}`;
                                span.textContent = char;
                                newParent.appendChild(span);
                            }
                        }
                        if (node.parentNode) {
                            node.parentNode.replaceChild(newParent, node);
                        }
                    } 
                    else if (node.nodeType === Node.ELEMENT_NODE || node.nodeType === Node.DOCUMENT_FRAGMENT_NODE) {
                        const children = Array.from(node.childNodes); 
                        for (const child of children) {
                            traverseAndColor(child);
                        }
                    }
                }

                traverseAndColor(fragment);

                const tempDiv = document.createElement('div');
                tempDiv.appendChild(fragment.cloneNode(true)); 
                const newHtml = tempDiv.innerHTML;

                globalInputEditor.focus();
                sel.removeAllRanges(); 
                sel.addRange(range);
                document.execCommand('insertHTML', false, newHtml);
                setTimeout(window.updateOutput, 1);
            });

            window.updateOutput();
            updateGradientDisplay();
        }

        function initializeMediaPanel() {
            imageInput.addEventListener('change', handleImageUpload);
            audioInput.addEventListener('change', handleAudioUpload);
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeWarcraftConverter();
            initializeMediaPanel();
            document.getElementById('language-selector').addEventListener('change', (e) => {
                updateUI(e.target.value);
            });
            updateUI('en'); 
        });
    </script>

</body>
</html>

