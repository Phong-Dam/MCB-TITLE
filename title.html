<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Name Form</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        input:invalid {
            border-color: #e53e3e;
        }
        input:invalid:focus {
            border-color: #e53e3e;
            box-shadow: 0 0 0 1px #e53e3e;
        }
        [contenteditable]:empty:before {
            content: attr(data-placeholder);
            pointer-events: none;
            display: block;
            color: #9ca3af; 
        }
        .control-btn {
            height: 44px; 
            min-width: 100px; 
        }
        .tab-btn {
            background-color: #f3f4f6;
            color: #374151;
        }
        .active-tab {
            background-color: #4f46e5;
            color: #ffffff;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans flex flex-col md:flex-row">

    <div class="w-full max-w-sm bg-white p-8 shadow-2xl z-10 overflow-y-auto">
        <h2 id="main-title" class="text-2xl font-bold mb-6 text-center text-gray-800">Information</h2>

        <form id="infoForm" onsubmit="handleSubmit(event)">
            <div class="mb-4">
                <label for="language-selector" id="language-label" class="block text-sm font-medium text-gray-700">Language</label>
                <select id="language-selector" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    <option value="en" selected>English</option>
                    <option value="id">Indonesia</option>
                    <option value="ru">Russia</option>
                    <option value="th">Thailand</option>
                    <option value="vi">Việt Nam</option>
                    <option value="ko">Korean</option>
                </select>
            </div>
            
            <div class="mb-4 flex items-center">
                <label for="name" id="name-label" class="block text-sm font-medium text-gray-700 mr-3 shrink-0">Name:</label>
                <input 
                    type="text" 
                    id="name" 
                    name="user_name" 
                    required 
                    maxlength="16" 
                    class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                    placeholder="Enter name (max 16 chars)"
                >
            </div>

            <div class="mb-2">
                <button 
                    type="button" 
                    id="loginTrigger-1" 
                    onclick="toggleLoginTabs(1)" 
                    class="group w-full flex items-center justify-between p-3 cursor-pointer list-none rounded-md border border-gray-300 bg-white hover:bg-gray-50 shadow-sm transition-colors"
                >
                    <span id="login1-text" class="font-medium text-gray-700">Login - 1</span>
                    <svg id="loginArrow-1" class="login-arrow w-5 h-5 text-gray-500 transition-transform duration-200" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                    </svg>
                </button>
                <div id="tabs-login-1" class="tabs-container hidden flex justify-center gap-2 py-2">
                    <button type="button" onclick="showColorPanel(1)" id="tab-name-1" class="tab-btn text-sm font-medium py-1 px-4 rounded-lg transition-colors">Name</button>
                    <button type="button" onclick="showImageSoundPanel(1)" id="tab-imagesound-1" class="tab-btn text-sm font-medium py-1 px-4 rounded-lg transition-colors">Image/Sound</button>
                </div>
            </div>

            <div class="mb-2">
                <button 
                    type="button" 
                    id="loginTrigger-2" 
                    onclick="toggleLoginTabs(2)" 
                    class="group w-full flex items-center justify-between p-3 cursor-pointer list-none rounded-md border border-gray-300 bg-white hover:bg-gray-50 shadow-sm transition-colors"
                >
                    <span id="login2-text" class="font-medium text-gray-700">Login - 2</span>
                    <svg id="loginArrow-2" class="login-arrow w-5 h-5 text-gray-500 transition-transform duration-200" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                    </svg>
                </button>
                <div id="tabs-login-2" class="tabs-container hidden flex justify-center gap-2 py-2">
                    <button type="button" onclick="showColorPanel(2)" id="tab-name-2" class="tab-btn text-sm font-medium py-1 px-4 rounded-lg transition-colors">Name</button>
                    <button type="button" onclick="showImageSoundPanel(2)" id="tab-imagesound-2" class="tab-btn text-sm font-medium py-1 px-4 rounded-lg transition-colors">Image/Sound</button>
                </div>
            </div>

            <div class="mb-4">
                <button 
                    type="button" 
                    id="loginTrigger-3" 
                    onclick="toggleLoginTabs(3)" 
                    class="group w-full flex items-center justify-between p-3 cursor-pointer list-none rounded-md border border-gray-300 bg-white hover:bg-gray-50 shadow-sm transition-colors"
                >
                    <span id="login3-text" class="font-medium text-gray-700">Login - 3</span>
                    <svg id="loginArrow-3" class="login-arrow w-5 h-5 text-gray-500 transition-transform duration-200" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                    </svg>
                </button>
                <div id="tabs-login-3" class="tabs-container hidden flex justify-center gap-2 py-2">
                    <button type="button" onclick="showColorPanel(3)" id="tab-name-3" class="tab-btn text-sm font-medium py-1 px-4 rounded-lg transition-colors">Name</button>
                    <button type="button" onclick="showImageSoundPanel(3)" id="tab-imagesound-3" class="tab-btn text-sm font-medium py-1 px-4 rounded-lg transition-colors">Image/Sound</button>
                </div>
            </div>
            
            
            <div id="message" class="mt-4 text-green-600 font-medium text-center"></div>

            <div class="mt-6">
                <button 
                    type="submit" 
                    id="save-button"
                    class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150"
                >
                    Save
                </button>
            </div>
        </form>
    </div>

    <div 
        id="loginPanel" 
        class="w-full flex-grow p-4 md:p-8 hidden bg-gray-900 overflow-auto"
    >
        <div class="max-w-4xl mx-auto bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-10 border border-indigo-700/50">
        
            <div class="relative mb-8 pt-1 pb-4">
                <h3 id="color-panel-title" class="text-xl font-bold text-center text-indigo-400">Edit Name</h3>
            </div>

            <div class="mb-8">
                <div class="flex justify-between items-center mb-2">
                    <label for="input-editor" class="block text-lg font-bold text-gray-200" id="input-label">
                        Input
                    </label>
                    <div class="flex items-center gap-2">
                        <label for="bg-color-picker" id="bg-color-label" class="text-sm font-medium text-indigo-400">Background Color</label>
                        <input type="color" id="bg-color-picker" value="#6B7280" 
                                class="w-10 h-8 p-1 bg-gray-700 border border-indigo-600 rounded-lg cursor-pointer shadow-md focus:ring-2 focus:ring-indigo-500">
                        
                    </div>
                </div>
                
                <div id="input-editor" 
                    contenteditable="true" 
                    data-placeholder="Type, paste content, or select text and apply colors..."
                    class="w-full min-h-[180px] p-4 font-mono text-white bg-gray-500 border-2 border-gray-600 rounded-xl shadow-inner focus:outline-none focus:ring-4 focus:ring-indigo-500 transition-all duration-300">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                
                <div class="flex flex-col space-y-4">
                    <div>
                        <label for="color-picker" class="block text-sm font-medium text-indigo-400 mb-1" id="start-color-label">
                            Start Color
                        </label>
                        <input type="color" id="color-picker" value="#374151" 
                                class="w-full h-10 p-1 bg-gray-700 border border-indigo-600 rounded-lg cursor-pointer shadow-md focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="color-picker-2" class="block text-sm font-medium text-indigo-400 mb-1" id="end-color-label">
                            End Color
                        </label>
                        <input type="color" id="color-picker-2" value="#EF4444" 
                                class="w-full h-10 p-1 bg-gray-700 border border-indigo-600 rounded-lg cursor-pointer shadow-md focus:ring-2 focus:ring-red-500">
                    </div>
                </div>

                <div class="md:col-span-2">
                    <label for="gradient-display" class="block text-sm font-medium text-indigo-400 mb-1" id="gradient-preview-label">
                        Gradient Preview
                    </label>
                    <div id="gradient-display" 
                            class="w-full h-32 border border-indigo-600 rounded-xl shadow-xl transition-all duration-300"
                            style="background: linear-gradient(to right, #374151, #EF4444);">
                    </div> 
                </div>
            </div>
            
            <div class="flex flex-wrap justify-center gap-3 mb-10">
                
                <button id="clear-color-button"
                        class="control-btn bg-gray-600 text-white text-sm font-bold py-2 px-4 rounded-lg shadow-lg hover:bg-gray-500 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-gray-300 transform hover:scale-[1.03] active:scale-[0.98]">
                    Clear Color
                </button>
                
                <button id="apply-color-button"
                        class="control-btn bg-indigo-600 text-white text-sm font-bold py-2 px-4 rounded-lg shadow-lg hover:bg-indigo-500 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-300 transform hover:scale-[1.03] active:scale-[0.98]">
                    Apply Color 1
                </button>
                
                <button id="apply-color-button-2"
                        class="control-btn bg-red-600 text-white text-sm font-bold py-2 px-4 rounded-lg shadow-lg hover:bg-red-500 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-red-300 transform hover:scale-[1.03] active:scale-[0.98]">
                    Apply Color 2
                </button>
                
                <button id="apply-gradient-button"
                        class="control-btn bg-purple-600 text-white text-sm font-bold py-2 px-4 rounded-lg shadow-lg hover:bg-purple-500 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-purple-300 transform hover:scale-[1.03] active:scale-[0.98]">
                    Create Gradient
                </button>
            </div>

            <div id="output-container" class="mt-8 hidden"> 
                <div class="flex justify-between items-center mb-2">
                    <label for="output-editor" id="output-label" class="block text-lg font-bold text-gray-200">
                        Output
                    </label>
                </div>
                
                <div id="output-editor" 
                    data-placeholder="Formatted result |c...|r will appear here..."
                    class="w-full min-h-[150px] p-4 border-2 border-gray-600 rounded-xl bg-gray-700 text-green-300 overflow-y-auto font-mono text-sm whitespace-pre-wrap select-all shadow-inner">
                </div>
            </div>

        </div>
    </div>

    <div 
        id="imageSoundPanel" 
        class="w-full flex-grow p-4 md:p-8 hidden bg-gray-900 overflow-auto"
    >
        <div class="max-w-4xl mx-auto bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-10 border border-indigo-700/50">
        
            <div class="relative mb-8 pt-1 pb-4">
                <h3 id="imagesound-panel-title" class="text-xl font-bold text-center text-indigo-400">Edit Image/Sound</h3>
            </div>

            <div class="mb-8">
                <label id="image-upload-label" class="block text-lg font-bold text-gray-200 mb-2">Upload Image (16:9, max 1920x1080)</label>
                <div class="flex items-center mt-2">
                    <label for="image-input" id="image-upload-button" class="cursor-pointer rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-700 transition-colors">
                        Choose File 
                    </label>
                    <span id="image-file-name" class="ml-4 text-gray-400 italic text-sm">No file chosen</span>
                    <input type="file" id="image-input" accept="image/png, image/jpeg" class="hidden">
                </div>
                <p id="image-error-msg" class="text-red-500 text-sm mt-2"></p>
                
                <img id="image-preview" src="" alt="Image preview" class="hidden mt-4 rounded-lg shadow-lg max-w-full h-auto bg-gray-700 p-1 border border-gray-600">
            </div>

            <div class="mb-8">
                <label id="audio-upload-label" class="block text-lg font-bold text-gray-200 mb-2">Upload Audio (Max 30 seconds)</label>
                <div class="flex items-center mt-2">
                    <label for="audio-input" id="audio-upload-button" class="cursor-pointer rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-700 transition-colors">
                        Choose File
                    </label>
                    <span id="audio-file-name" class="ml-4 text-gray-400 italic text-sm">No file chosen</span>
                    <input type="file" id="audio-input" accept="audio/*" class="hidden">
                </div>
                <p id="audio-error-msg" class="text-red-500 text-sm mt-2"></p>
                
                <audio id="audio-preview" controls class="hidden w-full mt-4"></audio>
            </div>

        </div>
    </div>


    <script>
        const translations = {
            'en': {
                doc_title: 'Name Form',
                main_title: 'Information',
                language_label: 'Language',
                name_label: 'Name:',
                name_placeholder: 'Enter name (max 16 chars)',
                login1: 'Login - 1',
                login2: 'Login - 2',
                login3: 'Login - 3',
                tab_name: 'Name',
                tab_imagesound: 'Image/Sound',
                save_button: 'Save',
                color_panel_title: 'Edit Name',
                input_label: 'Input',
                input_placeholder: 'Type, paste content, or select text and apply colors...',
                bg_color_label: 'Background Color',
                start_color_label: 'Start Color',
                end_color_label: 'End Color',
                gradient_preview_label: 'Gradient Preview',
                clear_color_button: 'Clear Color',
                apply_color_1_button: 'Apply Color 1',
                apply_color_2_button: 'Apply Color 2',
                create_gradient_button: 'Create Gradient',
                imagesound_panel_title: 'Edit Image/Sound',
                image_upload_label: 'Upload Image (16:9, max 1920x1080)',
                audio_upload_label: 'Upload Audio (Max 30 seconds)',
                choose_file: 'Choose File',
                output_label: 'Output',
                output_placeholder: 'Formatted result |c...|r will appear here...',
                image_alt: 'Image preview',
                no_file_chosen: 'No file chosen',
                error_name_required: 'Error: Please enter a Name in the top field.',
                error_output_length: (num, len) => `Error: 'Name' content for Login ${num} (${len} chars) exceeds 100 characters.`,
                error_filename_length: (name, num) => `Error: Filename '${name}' (Login ${num}) exceeds 100 characters.`,
                submit_success: 'Saved successfully!',
                error_image_size: (w, h) => `Error: Image size (${w}x${h}) exceeds 1920x1080.`,
                error_image_ratio: (ratio) => `Error: Image ratio (${ratio.toFixed(2)}) is not 16:9.`,
                error_invalid_file: 'Invalid file, please choose again.',
                error_read_image: 'Error: Cannot read image file.',
                error_image_type: 'Error: Only .png or .jpg files are accepted.',
                error_audio_duration: (duration) => `Error: Audio is too long (${duration.toFixed(1)}s), 30s max allowed.`,
                error_read_audio: 'Error: Cannot read audio file.'
            },
            'vi': {
                doc_title: 'Biểu mẫu nhập tên',
                main_title: 'Thông tin',
                language_label: 'Ngôn ngữ',
                name_label: 'Name:',
                name_placeholder: 'Nhập tên (tối đa 16 ký tự)',
                login1: 'Login - 1',
                login2: 'Login - 2',
                login3: 'Login - 3',
                tab_name: 'Tên',
                tab_imagesound: 'Ảnh/Âm thanh',
                save_button: 'Lưu',
                color_panel_title: 'Chỉnh sửa Tên',
                input_label: 'Đầu vào',
                input_placeholder: 'Gõ, dán nội dung, hoặc bôi đen và áp dụng màu sắc...',
                bg_color_label: 'Màu Nền',
                start_color_label: 'Màu Bắt đầu',
                end_color_label: 'Màu Kết thúc',
                gradient_preview_label: 'Xem trước Gradient',
                clear_color_button: 'Xóa Màu',
                apply_color_1_button: 'Áp Dụng Màu 1',
                apply_color_2_button: 'Áp Dụng Màu 2',
                create_gradient_button: 'Tạo Gradient',
                imagesound_panel_title: 'Chỉnh sửa Ảnh/Âm thanh',
                image_upload_label: 'Tải ảnh (16:9, max 1920x1080)',
                audio_upload_label: 'Tải âm thanh (Tối đa 30 giây)',
                choose_file: 'Chọn tệp',
                output_label: 'Đầu ra',
                output_placeholder: 'Kết quả định dạng |c...|r sẽ xuất hiện ở đây...',
                image_alt: 'Xem trước ảnh',
                no_file_chosen: 'Chưa chọn tệp',
                error_name_required: 'Lỗi: Vui lòng nhập Name ở ô trên cùng.',
                error_output_length: (num, len) => `Lỗi: Nội dung 'Name' của Login ${num} (${len} ký tự) vượt quá 100 ký tự.`,
                error_filename_length: (name, num) => `Lỗi: Tên tệp '${name}' (Login ${num}) quá 100 ký tự.`,
                submit_success: 'Lưu thành công!',
                error_image_size: (w, h) => `Lỗi: Kích thước ảnh (${w}x${h}) vượt quá 1920x1080.`,
                error_image_ratio: (ratio) => `Lỗi: Tỷ lệ ảnh (${ratio.toFixed(2)}) không phải 16:9.`,
                error_invalid_file: 'Tệp không hợp lệ, vui lòng chọn lại.',
                error_read_image: 'Lỗi: Không thể đọc tệp ảnh.',
                error_image_type: 'Lỗi: Chỉ chấp nhận tệp .png hoặc .jpg.',
                error_audio_duration: (duration) => `Lỗi: Âm thanh dài (${duration.toFixed(1)}s), chỉ cho phép 30s.`,
                error_read_audio: 'Lỗi: Không thể đọc tệp âm thanh.'
            }
        };

        translations.id = {
            ...translations.en,
            doc_title: 'Formulir Nama',
            main_title: 'Informasi',
            language_label: 'Bahasa',
            name_placeholder: 'Masukkan nama (maks 16 karakter)',
            tab_name: 'Nama',
            tab_imagesound: 'Gambar/Suara',
            save_button: 'Simpan',
            color_panel_title: 'Edit Nama',
            input_label: 'Masukan',
            input_placeholder: 'Ketik, tempel konten, atau pilih teks...',
            bg_color_label: 'Warna Latar',
            start_color_label: 'Warna Awal',
            end_color_label: 'Warna Akhir',
            gradient_preview_label: 'Pratinjau Gradien',
            clear_color_button: 'Hapus Warna',
            apply_color_1_button: 'Terapkan Warna 1',
            apply_color_2_button: 'Terapkan Warna 2',
            create_gradient_button: 'Buat Gradien',
            imagesound_panel_title: 'Edit Gambar/Suara',
            image_upload_label: 'Unggah Gambar (16:9, maks 1920x1080)',
            audio_upload_label: 'Unggah Audio (Maks 30 detik)',
            choose_file: 'Pilih File',
            output_label: 'Keluaran',
            output_placeholder: 'Hasil format |c...|r akan muncul di sini...',
            image_alt: 'Pratinjau gambar',
            no_file_chosen: 'Tidak ada file yang dipilih',
            error_name_required: 'Kesalahan: Harap masukkan Nama di bidang atas.',
            submit_success: 'Berhasil disimpan!',
        };
        
        translations.ru = {
            ...translations.en,
            doc_title: 'Форма имени',
            main_title: 'Информация',
            language_label: 'Язык',
            name_placeholder: 'Введите имя (макс 16 симв)',
            tab_name: 'Имя',
            tab_imagesound: 'Изобр./Звук',
            save_button: 'Сохранить',
            color_panel_title: 'Редакт. Имя',
            input_label: 'Ввод',
            input_placeholder: 'Введите, вставьте контент или выберите текст...',
            bg_color_label: 'Цвет фона',
            start_color_label: 'Начальный цвет',
            end_color_label: 'Конечный цвет',
            gradient_preview_label: 'Просмотр градиента',
            clear_color_button: 'Очистить цвет',
            apply_color_1_button: 'Применить цвет 1',
            apply_color_2_button: 'Применить цвет 2',
            create_gradient_button: 'Создать градиент',
            imagesound_panel_title: 'Редакт. Изобр./Звук',
            image_upload_label: 'Загрузить изображение (16:9, макс 1920x1080)',
            audio_upload_label: 'Загрузить аудио (Макс 30 секунд)',
            choose_file: 'Выберите файл',
            output_label: 'Вывод',
            output_placeholder: 'Результат |c...|r появится здесь...',
            image_alt: 'Просмотр изображения',
            no_file_chosen: 'Файл не выбран',
            error_name_required: 'Ошибка: Пожалуйста, введите имя в верхнем поле.',
            submit_success: 'Успешно сохранено!',
        };
        
        translations.th = {
            ...translations.en,
            doc_title: 'ฟอร์มชื่อ',
            main_title: 'ข้อมูล',
            language_label: 'ภาษา',
            name_placeholder: 'ป้อนชื่อ (สูงสุด 16 ตัวอักษร)',
            tab_name: 'ชื่อ',
            tab_imagesound: 'รูป/เสียง',
            save_button: 'บันทึก',
            color_panel_title: 'แก้ไขชื่อ',
            input_label: 'อินพุต',
            input_placeholder: 'พิมพ์, วางเนื้อหา, หรือเลือกข้อความ...',
            bg_color_label: 'สีพื้นหลัง',
            start_color_label: 'สีเริ่มต้น',
            end_color_label: 'สีสิ้นสุด',
            gradient_preview_label: 'ตัวอย่างไล่สี',
            clear_color_button: 'ล้างสี',
            apply_color_1_button: 'ใช้สี 1',
            apply_color_2_button: 'ใช้สี 2',
            create_gradient_button: 'สร้างไล่สี',
            imagesound_panel_title: 'แก้ไขรูปภาพ/เสียง',
            image_upload_label: 'อัปโหลดรูปภาพ (16:9, สูงสุด 1920x1080)',
            audio_upload_label: 'อัปโหลดเสียง (สูงสุด 30 วินาที)',
            choose_file: 'เลือกไฟล์',
            output_label: 'เอาต์พุต',
            output_placeholder: 'ผลลัพธ์ |c...|r จะปรากฏที่นี่...',
            image_alt: 'ตัวอย่างรูปภาพ',
            no_file_chosen: 'ยังไม่ได้เลือกไฟล์',
            error_name_required: 'ข้อผิดพลาด: กรุณาป้อนชื่อในช่องด้านบน',
            submit_success: 'บันทึกสำเร็จ!',
        };
        
        translations.ko = {
            ...translations.en,
            doc_title: '이름 양식',
            main_title: '정보',
            language_label: '언어',
            name_placeholder: '이름 입력 (최대 16자)',
            tab_name: '이름',
            tab_imagesound: '이미지/소리',
            save_button: '저장',
            color_panel_title: '이름 편집',
            input_label: '입력',
            input_placeholder: '내용 입력, 붙여넣기 또는 텍스트 선택...',
            bg_color_label: '배경색',
            start_color_label: '시작 색상',
            end_color_label: '끝 색상',
            gradient_preview_label: '그라데이션 미리보기',
            clear_color_button: '색상 지우기',
            apply_color_1_button: '색상 1 적용',
            apply_color_2_button: '색상 2 적용',
            create_gradient_button: '그라데이션 만들기',
            imagesound_panel_title: '이미지/소리 편집',
            image_upload_label: '이미지 업로드 (16:9, 최대 1920x1080)',
            audio_upload_label: '오디오 업로드 (최대 30초)',
            choose_file: '파일 선택',
            output_label: '출력',
            output_placeholder: '결과 |c...|r가 여기에 표시됩니다...',
            image_alt: '이미지 미리보기',
            no_file_chosen: '선택된 파일 없음',
            error_name_required: '오류: 상단 필드에 이름을 입력하세요.',
            submit_success: '성공적으로 저장되었습니다!',
        };


        let currentLanguage = 'en';

        function updateUI(lang) {
            currentLanguage = lang;
            const t = translations[lang] || translations['en'];

            document.documentElement.lang = lang;
            
            const setText = (id, key) => {
                const el = document.getElementById(id);
                if (el) el.textContent = t[key];
            };
            const setAttr = (id, attr, key) => {
                const el = document.getElementById(id);
                if (el) el.setAttribute(attr, t[key]);
            };

            document.title = t.doc_title;

            setText('main-title', 'main_title');
            setText('language-label', 'language_label');
            setText('name-label', 'name_label');
            setAttr('name', 'placeholder', 'name_placeholder');
            setText('login1-text', 'login1');
            setText('login2-text', 'login2');
            setText('login3-text', 'login3');
            setText('save-button', 'save_button');

            document.querySelectorAll('[id^="tab-name-"]').forEach(el => el.textContent = t.tab_name);
            document.querySelectorAll('[id^="tab-imagesound-"]').forEach(el => el.textContent = t.tab_imagesound);

            setText('color-panel-title', 'color_panel_title');
            setText('input-label', 'input_label');
            setAttr('input-editor', 'data-placeholder', 'input_placeholder');
            setText('bg-color-label', 'bg_color_label');
            setText('start-color-label', 'start_color_label');
            setText('end-color-label', 'end_color_label');
            setText('gradient-preview-label', 'gradient_preview_label');
            setText('clear-color-button', 'clear_color_button');
            setText('apply-color-button', 'apply_color_1_button');
            setText('apply-color-button-2', 'apply_color_2_button');
            setText('apply-gradient-button', 'create_gradient_button');
            setText('output-label', 'output_label');
            setAttr('output-editor', 'data-placeholder', 'output_placeholder');

            setText('imagesound-panel-title', 'imagesound_panel_title');
            setText('image-upload-label', 'image_upload_label');
            setText('audio-upload-label', 'audio_upload_label');
            setAttr('image-preview', 'alt', 'image_alt');
            
            setText('image-upload-button', 'choose_file');
            setText('audio-upload-button', 'choose_file');
            
            if (!loginData[currentActiveContext?.number]?.imageName) {
                setText('image-file-name', 'no_file_chosen');
            }
             if (!loginData[currentActiveContext?.number]?.audioName) {
                setText('audio-file-name', 'no_file_chosen');
            }
        }

        const loginPanel = document.getElementById('loginPanel');
        const imageSoundPanel = document.getElementById('imageSoundPanel');
        const allTabContainers = document.querySelectorAll('.tabs-container');
        const allLoginArrows = document.querySelectorAll('.login-arrow');
        const allTabButtons = document.querySelectorAll('.tab-btn');
        const inputEditor = document.getElementById('input-editor');

        let loginData = {
            1: { name: '', output: '', imageUrl: null, imageFile: null, audioUrl: null, audioFile: null, imageName: '', audioName: '' },
            2: { name: '', output: '', imageUrl: null, imageFile: null, audioUrl: null, audioFile: null, imageName: '', audioName: '' },
            3: { name: '', output: '', imageUrl: null, imageFile: null, audioUrl: null, audioFile: null, imageName: '', audioName: '' }
        };
        let currentActiveContext = null;

        const imageInput = document.getElementById('image-input');
        const imagePreview = document.getElementById('image-preview');
        const imageErrorMsg = document.getElementById('image-error-msg');
        const imageFileName = document.getElementById('image-file-name');
        
        const audioInput = document.getElementById('audio-input');
        const audioPreview = document.getElementById('audio-preview');
        const audioFileName = document.getElementById('audio-file-name');
        const audioErrorMsg = document.getElementById('audio-error-msg');

        async function convertCanvasToTgaBlob(canvas) {
            const ctx = canvas.getContext('2d', { willReadFrequently: true });
            const width = canvas.width;
            const height = canvas.height;
            const imageData = ctx.getImageData(0, 0, width, height);
            const data = imageData.data;

            const header = new Uint8Array(18);
            header.fill(0);
            header[2] = 10;
            header[12] = width & 0xFF;
            header[13] = (width >> 8) & 0xFF;
            header[14] = height & 0xFF;
            header[15] = (height >> 8) & 0xFF;
            header[16] = 24;
            header[17] = 0x20;

            const pixels = [];
            for (let i = 0; i < data.length; i += 4) {
                pixels.push(data[i + 2]);
                pixels.push(data[i + 1]);
                pixels.push(data[i + 0]);
            }

            const rleData = [];
            let i = 0;
            const pixelCount = width * height;
            
            while (i < pixels.length) {
                let runLength = 1;
                let isRunPacket = true;
                
                while (i + runLength * 3 < pixels.length && runLength < 128) {
                    if (pixels[i] !== pixels[i + runLength * 3] ||
                        pixels[i + 1] !== pixels[i + runLength * 3 + 1] ||
                        pixels[i + 2] !== pixels[i + runLength * 3 + 2]) {
                        break;
                    }
                    runLength++;
                }

                if (runLength > 1) {
                    rleData.push(0x80 | (runLength - 1));
                    rleData.push(pixels[i], pixels[i + 1], pixels[i + 2]);
                    i += runLength * 3;
                } else {
                    let rawLength = 1;
                    while (i + rawLength * 3 < pixels.length && rawLength < 128) {
                        if (i + (rawLength + 1) * 3 < pixels.length &&
                            pixels[i + rawLength * 3] === pixels[i + (rawLength + 1) * 3] &&
                            pixels[i + rawLength * 3 + 1] === pixels[i + (rawLength + 1) * 3 + 1] &&
                            pixels[i + rawLength * 3 + 2] === pixels[i + (rawLength + 1) * 3 + 2]) {
                            break;
                        }
                        rawLength++;
                    }
                    
                    rleData.push(rawLength - 1);
                    for (let k = 0; k < rawLength; k++) {
                        rleData.push(pixels[i + k * 3]);
                        rleData.push(pixels[i + k * 3 + 1]);
                        rleData.push(pixels[i + k * 3 + 2]);
                    }
                    i += rawLength * 3;
                }
            }

            const tgaFile = new Uint8Array(header.length + rleData.length);
            tgaFile.set(header);
            tgaFile.set(rleData, header.length);

            return new Blob([tgaFile], { type: 'image/tga' });
        }

        function saveCurrentContext() {
            if (!currentActiveContext) return;
            const { number, type } = currentActiveContext;

            if (type === 'name' && inputEditor) {
                loginData[number].name = inputEditor.innerHTML;
                
                if (window.updateOutput) window.updateOutput();
                const outputEditor = document.getElementById('output-editor');
                if (outputEditor) {
                    loginData[number].output = outputEditor.textContent;
                }
            }
        }

        function toggleLoginTabs(loginNumber) {
            const tabsToToggle = document.getElementById(`tabs-login-${loginNumber}`);
            const arrowToToggle = document.getElementById(`loginArrow-${loginNumber}`);
            
            const isOpening = tabsToToggle.classList.contains('hidden');
            const previousContext = currentActiveContext ? { ...currentActiveContext } : null;

            if (!isOpening && previousContext && previousContext.number === loginNumber) {
                saveCurrentContext();
                currentActiveContext = null;
                loginPanel.classList.add('hidden');
                imageSoundPanel.classList.add('hidden');
                setActiveTab(null);
            } 
            else if (isOpening && previousContext) {
                saveCurrentContext();
            }

            allTabContainers.forEach(container => container.classList.add('hidden'));
            allLoginArrows.forEach(arrow => arrow.classList.remove('rotate-180'));

            if (isOpening) {
                tabsToToggle.classList.remove('hidden');
                arrowToToggle.classList.add('rotate-180');

                if (previousContext && previousContext.number !== loginNumber) {
                    if (previousContext.type === 'name') {
                        showColorPanel(loginNumber);
                    } else if (previousContext.type === 'imagesound') {
                        showImageSoundPanel(loginNumber);
                    }
                }
            }
        }
        
        function setActiveTab(activeId) {
            allTabButtons.forEach(button => {
                button.classList.remove('active-tab');
                button.classList.add('tab-btn');
            });

            if (activeId) {
                const activeButton = document.getElementById(activeId);
                if (activeButton) {
                    activeButton.classList.remove('tab-btn');
                    activeButton.classList.add('active-tab');
                }
            }
        }

        function showColorPanel(loginNumber) {
            saveCurrentContext();
            currentActiveContext = { number: loginNumber, type: 'name' };

            if (inputEditor) {
                inputEditor.innerHTML = loginData[loginNumber].name;
                if (window.updateOutput) {
                    window.updateOutput();
                }
            }

            imageSoundPanel.classList.add('hidden');
            loginPanel.classList.remove('hidden');
            setActiveTab(`tab-name-${loginNumber}`);
        }

        function showImageSoundPanel(loginNumber) {
            saveCurrentContext();
            currentActiveContext = { number: loginNumber, type: 'imagesound' };
            
            loadMediaState(loginNumber);

            loginPanel.classList.add('hidden');
            imageSoundPanel.classList.remove('hidden');
            setActiveTab(`tab-imagesound-${loginNumber}`);
        }

        function loadMediaState(loginNumber) {
            const data = loginData[loginNumber];
            const t = translations[currentLanguage] || translations['en'];

            if (data.imageUrl) {
                imagePreview.src = data.imageUrl;
                imagePreview.classList.remove('hidden');
            } else {
                imagePreview.src = '';
                imagePreview.classList.add('hidden');
            }
            imageErrorMsg.textContent = '';
            imageInput.value = '';
            imageFileName.textContent = data.imageName || t.no_file_chosen;

            if (data.audioUrl) {
                audioPreview.src = data.audioUrl;
                audioPreview.classList.remove('hidden');
            } else {
                audioPreview.src = '';
                audioPreview.classList.add('hidden');
            }
            audioErrorMsg.textContent = '';
            audioInput.value = '';
            audioFileName.textContent = data.audioName || t.no_file_chosen;
        }

        function showMessage(text, isError = false) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            if (isError) {
                messageEl.classList.remove('text-green-600');
                messageEl.classList.add('text-red-600');
            } else {
                messageEl.classList.add('text-green-600');
                messageEl.classList.remove('text-red-600');
            }
            setTimeout(() => { 
                messageEl.textContent = ''; 
                messageEl.classList.remove('text-red-600');
                messageEl.classList.add('text-green-600');
            }, 3000);
        }

        function handleSubmit(event) {
            event.preventDefault(); 
            const t = translations[currentLanguage] || translations['en'];
            
            saveCurrentContext();

            const mainNameValue = document.getElementById('name').value;
            if (!mainNameValue) {
                showMessage(t.error_name_required, true);
                return;
            }

            let fileContent = `if CurLog=="${mainNameValue}" then\n`;
            const zip = new JSZip();
            const folder = zip.folder("Title");
            let hasFiles = false;

            for (let i = 1; i <= 3; i++) {
                const data = loginData[i];
                
                const outputText = data.output ? data.output.trim() : '';
                if (outputText.length > 100) {
                    showMessage(t.error_output_length(i, outputText.length), true);
                    return;
                }

                const hasName = outputText !== '';
                const hasSound = !!data.audioFile; 
                const hasImage = !!data.imageFile;
                
                if (hasSound) {
                    const audExt = data.audioFile.name.split('.').pop() || 'mp3';
                    const newAudioName = `${mainNameValue}${i}.${audExt}`;
                    if (newAudioName.length > 100) {
                        showMessage(t.error_filename_length(newAudioName, i), true);
                        return;
                    }
                }
                if (hasImage) {
                    const imgExt = 'tga';
                    const newImageName = `${mainNameValue}${i}.${imgExt}`;
                    if (newImageName.length > 100) {
                        showMessage(t.error_filename_length(newImageName, i), true);
                        return;
                    }
                }

                if (hasName || hasSound || hasImage) {
                    fileContent += `if str=="-login${i}" then\n`;
                    hasFiles = true;
                    
                    if (hasName) {
                        const safeOutput = outputText.replace(/"/g, '\\"');
                        fileContent += `call SetPlayerName(p,"${safeOutput}")\n`; 
                    }
                    if (hasSound) {
                        const audExt = data.audioFile.name.split('.').pop() || 'mp3';
                        const newAudioName = `${mainNameValue}${i}.${audExt}`;
                        
                        fileContent += `call PlaySoundEx("Title\\\\${newAudioName}",270)\n`;
                        folder.file(newAudioName, data.audioFile);
                    }
                    if (hasImage) {
                        const imgExt = 'tga';
                        const newImageName = `${mainNameValue}${i}.${imgExt}`;
                        
                        fileContent += `call CinematicFilterGenericBJ(3.,BLEND_MODE_BLEND,"Title\\\\${newImageName}",100.,100,100,0.,100.,100.,100.,100.)\n`;
                        folder.file(newImageName, data.imageFile);
                    }
                    fileContent += `endif\n`;
                }
            }

            fileContent += `endif\n`;

            if (hasFiles) {
                zip.file("Name.txt", fileContent);
            } else {
                 zip.file("Name.txt", fileContent);
            }

            zip.generateAsync({ type: "blob" })
               .then(function(content) {
                   downloadBlob(content, `${mainNameValue}.zip`);
               });

            showMessage(t.submit_success, false);
            
            loginPanel.classList.add('hidden');
            imageSoundPanel.classList.add('hidden');
            allTabContainers.forEach(container => container.classList.add('hidden'));
            allLoginArrows.forEach(arrow => arrow.classList.remove('rotate-180'));
            setActiveTab(null);

            for (let i = 1; i <= 3; i++) {
                if (loginData[i].imageUrl && loginData[i].imageUrl.startsWith('blob:')) {
                    URL.revokeObjectURL(loginData[i].imageUrl);
                }
                if (loginData[i].audioUrl && loginData[i].audioUrl.startsWith('blob:')) {
                    URL.revokeObjectURL(loginData[i].audioUrl);
                }
            }

            loginData = {
                1: { name: '', output: '', imageUrl: null, imageFile: null, audioUrl: null, audioFile: null, imageName: '', audioName: '' },
                2: { name: '', output: '', imageUrl: null, imageFile: null, audioUrl: null, audioFile: null, imageName: '', audioName: '' },
                3: { name: '', output: '', imageUrl: null, imageFile: null, audioUrl: null, audioFile: null, imageName: '', audioName: '' }
            };
            currentActiveContext = null;
            
            if (inputEditor) {
                inputEditor.innerHTML = ''; 
                if (window.updateOutput) window.updateOutput();
            }
            loadMediaState(1); 

            document.getElementById('infoForm').reset(); 
        }

        function downloadBlob(blob, fileName) {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(a.href);
        }

        function handleStandardImageUpload(file, number, objectUrl) {
            const img = new Image();
            img.onload = async () => {
                const w = img.width;
                const h = img.height;
                const ratio = w / h;
                const expectedRatio = 16 / 9;
                let valid = true;
                const t = translations[currentLanguage] || translations['en'];

                if (w > 1920 || h > 1080) {
                    imageErrorMsg.textContent = t.error_image_size(w, h);
                    valid = false;
                }
                
                if (Math.abs(ratio - expectedRatio) > 0.02) { 
                    imageErrorMsg.textContent = t.error_image_ratio(ratio);
                    valid = false;
                }

                if (valid) {
                    const canvas = document.createElement('canvas');
                    canvas.width = w;
                    canvas.height = h;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);

                    const tgaBlob = await convertCanvasToTgaBlob(canvas);

                    imagePreview.src = objectUrl;
                    imagePreview.classList.remove('hidden');
                    loginData[number].imageUrl = objectUrl;
                    
                    loginData[number].imageFile = tgaBlob;
                    
                    loginData[number].imageName = file.name;
                    imageFileName.textContent = file.name;
                } else {
                    URL.revokeObjectURL(objectUrl);
                    imageInput.value = ''; 
                    imageErrorMsg.textContent = t.error_invalid_file;
                    imageFileName.textContent = t.no_file_chosen;
                }
            };

            img.onerror = () => {
                 const t = translations[currentLanguage] || translations['en'];
                 imageErrorMsg.textContent = t.error_read_image;
                 URL.revokeObjectURL(objectUrl);
                 imageInput.value = '';
                 imageFileName.textContent = t.no_file_chosen;
            };
            
            img.src = objectUrl;
        }


        function handleImageUpload(e) {
            if (!currentActiveContext || currentActiveContext.type !== 'imagesound') return;
            
            const file = e.target.files[0];
            const { number } = currentActiveContext;
            const t = translations[currentLanguage] || translations['en'];

            imageErrorMsg.textContent = '';
            imagePreview.classList.add('hidden');
            
            if (loginData[number].imageUrl && loginData[number].imageUrl.startsWith('blob:')) {
                URL.revokeObjectURL(loginData[number].imageUrl);
            }
            
            loginData[number].imageUrl = null;
            loginData[number].imageFile = null;
            loginData[number].imageName = '';
            
            if (!file) {
                imageFileName.textContent = t.no_file_chosen;
                return;
            }

            const allowedTypes = ['image/png', 'image/jpeg'];
            
            if (allowedTypes.includes(file.type)) {
                const objectUrl = URL.createObjectURL(file);
                handleStandardImageUpload(file, number, objectUrl);
            } else {
                imageErrorMsg.textContent = t.error_image_type;
                imageFileName.textContent = t.no_file_chosen;
                imageInput.value = ''; 
            }
        }

        function handleAudioUpload(e) {
            if (!currentActiveContext || currentActiveContext.type !== 'imagesound') return;

            const file = e.target.files[0];
            const { number } = currentActiveContext;
            const t = translations[currentLanguage] || translations['en'];

            audioPreview.classList.add('hidden');
            audioPreview.src = '';
            audioErrorMsg.textContent = '';

            if (loginData[number].audioUrl) {
                URL.revokeObjectURL(loginData[number].audioUrl);
            }
            loginData[number].audioUrl = null;
            loginData[number].audioFile = null;
            loginData[number].audioName = '';
            
            if (!file) {
                audioFileName.textContent = t.no_file_chosen;
                return;
            }

            const objectUrl = URL.createObjectURL(file);

            const audio = document.createElement('audio');
            
            audio.addEventListener('loadedmetadata', () => {
                const duration = audio.duration;
                if (duration > 30) {
                    audioErrorMsg.textContent = t.error_audio_duration(duration);
                    audioFileName.textContent = t.no_file_chosen;
                    URL.revokeObjectURL(objectUrl); 
                    audioInput.value = ''; 
                } else {
                    audioErrorMsg.textContent = '';
                    audioPreview.src = objectUrl;
                    audioPreview.classList.remove('hidden');
                    loginData[number].audioUrl = objectUrl;
                    loginData[number].audioFile = file;
                    loginData[number].audioName = file.name;
                    audioFileName.textContent = file.name;
                }
            });
            
            audio.addEventListener('error', () => {
                audioErrorMsg.textContent = t.error_read_audio;
                audioFileName.textContent = t.no_file_chosen;
                URL.revokeObjectURL(objectUrl);
                audioInput.value = '';
            });
            
            audio.src = objectUrl; 
        }

        let globalInputEditor; 

        function initializeWarcraftConverter() {
            globalInputEditor = document.getElementById('input-editor'); 
            if (!globalInputEditor) return; 

            const outputEditor = document.getElementById('output-editor');
            const colorPicker = document.getElementById('color-picker');
            const applyColorButton = document.getElementById('apply-color-button');
            const colorPicker2 = document.getElementById('color-picker-2');
            const applyColorButton2 = document.getElementById('apply-color-button-2');
            const applyGradientButton = document.getElementById('apply-gradient-button');
            const gradientDisplay = document.getElementById('gradient-display');
            const clearColorButton = document.getElementById('clear-color-button');
            const outputContainer = document.getElementById('output-container'); 
            const bgColorPicker = document.getElementById('bg-color-picker');

            globalInputEditor.style.backgroundColor = bgColorPicker.value;
            
            function parseNodeToObjects(node, dataArray, defaultColor) {
                const localInputEditor = globalInputEditor || document.getElementById('input-editor');
                if (node.nodeType === Node.TEXT_NODE) {
                    const text = node.textContent;
                    if (text.length === 0) return; 

                    let color = defaultColor; 
                    let parent = node.parentElement;
                    
                    while (parent && parent !== localInputEditor) {
                        if (parent.nodeName === 'SPAN' && parent.style.color) {
                            color = parent.style.color; 
                            break;
                        }
                        if (parent.nodeName === 'FONT' && parent.getAttribute('color')) {
                            color = parent.getAttribute('color'); 
                            break;
                        }
                        parent = parent.parentElement;
                    }
                    
                    dataArray.push({
                        Color: color, 
                        Text: text 
                    });

                } 
                else if (node.nodeType === Node.ELEMENT_NODE) {
                    if (node.nodeName === 'BR' || (node.nodeName === 'DIV' && node.childNodes.length === 0)) {
                            if (dataArray.length > 0 && dataArray[dataArray.length - 1].Text !== '\n') {
                                dataArray.push({ Color: defaultColor, Text: '\n' });
                            }
                    } else if (node.nodeName === 'DIV') {
                            if (dataArray.length > 0 && dataArray[dataArray.length - 1].Text !== '\n') {
                                dataArray.push({ Color: defaultColor, Text: '\n' });
                            }
                            node.childNodes.forEach(child => parseNodeToObjects(child, dataArray, defaultColor));
                    }
                    else {
                        node.childNodes.forEach(child => parseNodeToObjects(child, dataArray, defaultColor));
                    }
                }
            }

            function rgbToHex(rgb) {
                if (rgb.startsWith('#')) {
                    return rgb.substring(1).toUpperCase();
                }
                
                const match = rgb.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
                
                if (!match) return '000000'; 

                const toHex = (c) => {
                    const num = Number(c);
                    const hex = num.toString(16);
                    return hex.length == 1 ? "0" + hex : hex;
                };

                const r = toHex(match[1]);
                const g = toHex(match[2]);
                const b = toHex(match[3]);
                
                return `${r}${g}${b}`.toUpperCase();
            }

            function lerp(a, b, t) {
                return a + (b - a) * t;
            }

            function hexToRgb(hex) {
                let r = 0, g = 0, b = 0;
                if (hex.length == 7) {
                    r = parseInt(hex.substring(1, 3), 16);
                    g = parseInt(hex.substring(3, 5), 16);
                    b = parseInt(hex.substring(5, 7), 16);
                }
                return { r, g, b };
            }
            
            function escapeHtml(text) {
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#03S9;'
                };
                return text.replace(/[&<>"']/g, (m) => map[m] || m); 
            }

            function updateGradientDisplay() {
                if (!colorPicker || !colorPicker2 || !gradientDisplay) return;
                const color1 = colorPicker.value;
                const color2 = colorPicker2.value;
                gradientDisplay.style.background = `linear-gradient(to right, ${color1}, ${color2})`;
            }

            window.updateOutput = function() {
                const localInputEditor = globalInputEditor || document.getElementById('input-editor');
                if (!localInputEditor || !outputEditor) return;

                const dataArray = [];
                const defaultEditorColor = window.getComputedStyle(localInputEditor).color; 
                const defaultEditorHex = rgbToHex(defaultEditorColor);

                localInputEditor.childNodes.forEach(node => parseNodeToObjects(node, dataArray, defaultEditorColor));
                
                while (dataArray.length > 0 && dataArray[dataArray.length - 1].Text === '\n') {
                    const lastNode = localInputEditor.childNodes[localInputEditor.childNodes.length - 1];
                    if (lastNode && (lastNode.nodeName === 'DIV' || lastNode.nodeName === 'BR') && !lastNode.textContent) {
                            dataArray.pop();
                    } else {
                            break;
                    }
                }
                
                const hasVisibleContent = dataArray.some(item => !/^\s*$/.test(item.Text));

                if (!hasVisibleContent) {
                        outputEditor.textContent = '';
                        return;
                }
                
                let outputString = '';
                let lastHexColor = ''; 

                for (const item of dataArray) {
                    const text = item.Text;
                    
                    if (text === '\n') {
                        if (lastHexColor && lastHexColor !== defaultEditorHex) {
                            outputString += '|r';
                        }
                        outputString += '|n';
                        lastHexColor = ''; 
                    } else {
                        const hexColor = rgbToHex(item.Color); 
                        const isDefaultColor = (hexColor === defaultEditorHex);
                        const isWhitespace = /^\s+$/.test(text);

                        if (isWhitespace) {
                            outputString += text;
                        }
                        else if (hexColor !== lastHexColor) {
                            if (isDefaultColor) {
                                if (lastHexColor && lastHexColor !== defaultEditorHex) {
                                        outputString += '|r';
                                }
                            } 
                            else {
                                outputString += `|cff${hexColor}`;
                            }
                            lastHexColor = hexColor;
                            outputString += text;
                        } else {
                            outputString += text;
                        }
                    }
                }
                
                if (lastHexColor && lastHexColor !== defaultEditorHex) {
                    outputString += '|r';
                }

                outputEditor.textContent = outputString;
            }

            globalInputEditor.addEventListener('input', window.updateOutput);
            globalInputEditor.addEventListener('keyup', window.updateOutput);
            globalInputEditor.addEventListener('mouseup', window.updateOutput);
            
            function convertAnsiToHtml(text) {
                let html = '';
                const parts = text.split(/(\|(?:c(?:ff)?[0-9a-fA-F]{6}|r|n))/g);
                
                let currentColor = ''; 

                for (const part of parts) {
                    if (part.startsWith('|c') && part.length === 8) {
                        const hex = part.substring(2);
                        if (currentColor) { html += '</span>'; }
                        html += `<span style="color: #${hex};">`;
                        currentColor = hex;
                    } 
                    else if (part.startsWith('|cff') && part.length === 10) {
                        const hex = part.substring(4); 
                        if (currentColor) { html += '</span>'; }
                        html += `<span style="color: #${hex};">`;
                        currentColor = hex;
                    }
                    else if (part === '|r') {
                        if (currentColor) { html += '</span>'; }
                        currentColor = '';
                    } else if (part === '|n') {
                        if (currentColor) { html += '</span>'; }
                        html += '<br>';
                        currentColor = ''; 
                    } else if (part) {
                        html += escapeHtml(part);
                    }
                }
                
                if (currentColor) {
                    html += '</span>';
                }
                return html;
            }

            globalInputEditor.addEventListener('paste', (e) => {
                e.preventDefault();
                const text = (e.clipboardData || window.clipboardData).getData('text/plain');
                
                if (text) {
                    if (text.includes('|c') || text.includes('|r') || text.includes('|n')) {
                        const html = convertAnsiToHtml(text);
                        document.execCommand('insertHTML', false, html);
                    } else {
                        document.execCommand('insertText', false, text);
                    }
                }
            });

            
            colorPicker.addEventListener('input', updateGradientDisplay);
            colorPicker2.addEventListener('input', updateGradientDisplay);

            bgColorPicker.addEventListener('input', () => {
                globalInputEditor.style.backgroundColor = bgColorPicker.value;
            });

            clearColorButton.addEventListener('mousedown', (e) => {
                e.preventDefault(); 
                globalInputEditor.focus();
                document.execCommand('removeFormat', false, null);
                setTimeout(window.updateOutput, 1);
            });
            
            applyColorButton.addEventListener('mousedown', (e) => {
                e.preventDefault(); 
                const color = colorPicker.value;
                globalInputEditor.focus();
                document.execCommand('foreColor', false, color);
                setTimeout(window.updateOutput, 1); 
            });
            
            applyColorButton2.addEventListener('mousedown', (e) => {
                e.preventDefault(); 
                const color = colorPicker2.value; 
                globalInputEditor.focus();
                document.execCommand('foreColor', false, color);
                setTimeout(window.updateOutput, 1);
            });
            
            applyGradientButton.addEventListener('mousedown', (e) => {
                e.preventDefault();
                const sel = window.getSelection();
                if (!sel.rangeCount || !globalInputEditor.contains(sel.getRangeAt(0).commonAncestorContainer)) return;

                const range = sel.getRangeAt(0);
                
                const textForCounting = range.toString();
                const nonWhitespaceChars = Array.from(textForCounting).filter(c => !/^\s*$/.test(c));
                const n = nonWhitespaceChars.length;
                if (n === 0) return; 

                const startRgb = hexToRgb(colorPicker.value);
                const endRgb = hexToRgb(colorPicker2.value);

                const fragment = range.cloneContents();
                let charIndex = 0; 

                function traverseAndColor(node) {
                    if (node.nodeType === Node.TEXT_NODE) {
                        const text = node.textContent;
                        if (text.length === 0) return;

                        const newParent = document.createDocumentFragment(); 
                        const chars = Array.from(text); 

                        for (const char of chars) {
                            if (/^\s*$/.test(char)) {
                                newParent.appendChild(document.createTextNode(char));
                            } else {
                                const t = (n <= 1) ? 0.5 : charIndex / (n - 1);
                                charIndex++; 

                                const r = Math.round(lerp(startRgb.r, endRgb.r, t));
                                const g = Math.round(lerp(startRgb.g, endRgb.g, t));
                                const b = Math.round(lerp(startRgb.b, endRgb.b, t));

                                const hexValue = [r, g, b].map(c => {
                                    const hex = c.toString(16);
                                    return hex.length == 1 ? "0" + hex : hex;
                                }).join('');
                                
                                const span = document.createElement('span');
                                span.style.color = `#${hexValue}`;
                                span.textContent = char;
                                newParent.appendChild(span);
                            }
                        }
                        if (node.parentNode) {
                            node.parentNode.replaceChild(newParent, node);
                        }
                    } 
                    else if (node.nodeType === Node.ELEMENT_NODE || node.nodeType === Node.DOCUMENT_FRAGMENT_NODE) {
                        const children = Array.from(node.childNodes); 
                        for (const child of children) {
                            traverseAndColor(child);
                        }
                    }
                }

                traverseAndColor(fragment);

                const tempDiv = document.createElement('div');
                tempDiv.appendChild(fragment.cloneNode(true)); 
                const newHtml = tempDiv.innerHTML;

                globalInputEditor.focus();
                sel.removeAllRanges(); 
                sel.addRange(range);
                document.execCommand('insertHTML', false, newHtml);
                setTimeout(window.updateOutput, 1);
            });

            window.updateOutput();
            updateGradientDisplay();
        }

        function initializeMediaPanel() {
            imageInput.addEventListener('change', handleImageUpload);
            audioInput.addEventListener('change', handleAudioUpload);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const languageSelector = document.getElementById('language-selector');
            languageSelector.addEventListener('change', (e) => updateUI(e.target.value));
            
            initializeWarcraftConverter();
            initializeMediaPanel();
            
            updateUI('en');
        });
    </script>

</body>
</html>

